<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI|QUOCDAT /title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #00ff88; --bg: #0a0a0f; --card-bg: #15151e; --border: #2a2a35; --accent: #00b8ff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; min-height: 100vh; display: flex; flex-direction: column; transition: background 0.3s; }
        .header { background: rgba(0,0,0,0.8); padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .brand { font-family: 'Orbitron'; font-size: 20px; font-weight: 900; color: #fff; }
        .brand span { color: var(--primary); }
        .btn-home { background: rgba(255,255,255,0.05); color: #fff; text-decoration: none; padding: 8px 15px; border-radius: 8px; font-size: 12px; font-weight: bold; font-family: 'Orbitron'; transition: 0.3s; border: 1px solid var(--border); cursor: pointer; }
        .btn-home:hover { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 10px rgba(0,255,136,0.3); }
        .container { max-width: 800px; margin: 20px auto; padding: 0 20px; flex: 1; display: flex; flex-direction: column; width: 100%; }
        .ai-status { text-align: center; margin-bottom: 10px; }
        .ai-status h2 { font-family: 'Orbitron'; color: var(--primary); font-size: 24px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0,255,136,0.5); }
        .ai-status p { color: #ff9f43; font-size: 13px; margin-top: 5px; font-family: monospace; }
        .chat-box { background: #000; border: 1px solid var(--primary); border-radius: 15px; flex: 1; min-height: 400px; padding: 20px; overflow-y: auto; font-family: monospace; box-shadow: inset 0 0 20px rgba(0,255,136,0.05); display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; scroll-behavior: smooth; }
        .msg { display: flex; flex-direction: column; max-width: 85%; }
        .msg-user { align-self: flex-end; align-items: flex-end; }
        .msg-ai { align-self: flex-start; align-items: flex-start; }
        .msg-name { font-size: 11px; color: #888; margin-bottom: 5px; font-weight: bold; }
        .msg-ai .msg-name { color: var(--primary); }
        .msg-user .msg-name { color: var(--accent); }
        .msg-system .msg-name { color: #ff9f43; }
        .msg-bubble { padding: 12px 18px; border-radius: 12px; font-size: 14px; line-height: 1.5; word-wrap: break-word; }
        .msg-user .msg-bubble { background: var(--accent); color: #000; border-bottom-right-radius: 2px; }
        .msg-ai .msg-bubble { background: rgba(0,255,136,0.1); color: var(--primary); border: 1px solid var(--primary); border-bottom-left-radius: 2px; text-shadow: 0 0 2px rgba(0,255,136,0.5); }
        .msg-system .msg-bubble { background: rgba(255,159,67,0.1); color: #ff9f43; border: 1px dashed #ff9f43; border-bottom-left-radius: 2px; }
        .typing-indicator { display: inline-block; width: 10px; height: 15px; background-color: var(--primary); animation: blink 1s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .input-area { display: flex; gap: 10px; background: var(--card-bg); padding: 15px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px; }
        .input-area input { flex: 1; background: transparent; border: none; color: #fff; font-size: 15px; outline: none; font-family: 'Inter'; }
        .input-area input:disabled { opacity: 0.5; }
        .btn-send { background: var(--primary); color: #000; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center; font-size: 18px; }
        .btn-send:disabled { background: #333; color: #777; cursor: not-allowed; }
        .btn-send:hover:not(:disabled) { filter: brightness(1.2); box-shadow: 0 0 15px rgba(0,255,136,0.3); transform: scale(1.05); }
        .tools-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .btn-clear { background: #333; color: #fff; border: none; padding: 5px 15px; border-radius: 5px; font-size: 11px; cursor: pointer; font-family: 'Orbitron'; transition: 0.3s; }
        .btn-clear:hover { background: #ff4757; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="brand">QUOCDAT<span>.AI</span></div>
            <a href="index.html" class="btn-home"><i class="fas fa-home"></i> TRANG CHỦ</a>
        </div>
    </div>
    <div class="container">
        <div class="ai-status">
            <h2>AI QUOCDAT</h2>
            <p><i class="fas fa-bolt"></i> test</p>
        </div>
        <div class="tools-bar">
            <button class="btn-clear" onclick="clearMemory()"><i class="fas fa-trash-alt"></i> XÓA LỊCH SỬ CHAT</button>
        </div>
        <div class="chat-box" id="chatBox"></div>
        <div class="input-area">
            <input type="text" id="userInput" placeholder="Hỏi câu gì khó khó tí xem..." autocomplete="off">
            <button class="btn-send" id="btnSend"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
    <script>
        const GROQ_API_KEY = "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"; 
        
        const fbConfig = { apiKey: "AIzaSyAWaCeduRtSP74OkRYJ6wvw8LPPkoLGsGc", databaseURL: "https://quocdat-b80c2-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "quocdat-b80c2" };
        if (!firebase.apps.length) firebase.initializeApp(fbConfig);
        const db = firebase.database();
        db.ref('settings').on('value', snap => {
            let s = snap.val() || {};
            if(s.theme_primary) document.documentElement.style.setProperty('--primary', s.theme_primary);
            if(s.theme_bg) document.documentElement.style.setProperty('--bg', s.theme_bg);
        });
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const btnSend = document.getElementById('btnSend');
        let aiBrainData = []; 
        let chatContext = JSON.parse(sessionStorage.getItem('ai_chat_history')) || [];
        db.ref('ai_brain_v2').on('value', snap => {
            aiBrainData = [];
            if(snap.exists()) {
                let data = snap.val();
                for(let key in data) {
                    let q = data[key].question || "";
                    let a = data[key].answer || "";
                    if (q && a) {
                        aiBrainData.push({ q: q.toString().toLowerCase().trim(), a: a.toString() });
                    }
                }
            }
        });
        function loadApp() {
            if (chatContext.length > 0) {
                chatContext.forEach(msg => {
                    let html = "";
                    if (msg.role === 'user') html = `<div class="msg msg-user"><span class="msg-name">GUEST <i class="fas fa-user"></i></span><div class="msg-bubble">${msg.text}</div></div>`;
                    else if (msg.role === 'ai') html = `<div class="msg msg-ai"><span class="msg-name"><i class="fas fa-robot"></i> QUOCDAT.AI</span><div class="msg-bubble">${msg.text}</div></div>`;
                    else html = `<div class="msg msg-system"><span class="msg-name"><i class="fas fa-cog"></i> SYSTEM</span><div class="msg-bubble">${msg.text}</div></div>`;
                    chatBox.insertAdjacentHTML('beforeend', html);
                });
                scrollToBottom();
                resetInput(); 
            } else {
                chatBox.innerHTML = `<div class="msg msg-ai"><span class="msg-name"><i class="fas fa-robot"></i> SYSTEM.AI</span><div class="msg-bubble" id="bootText"></div></div>`;
                setTimeout(typeBootSequence, 300);
            }
        }
        const bootSequence = ["Kích hoạt lõi LPU siêu tốc...", "Gắn API chính chủ thành công!", "Tôi là siêu AI trợ lý. Xin chào!"];
        let bootIndex = 0; let bootCharIndex = 0; let currentBootLine = "";
        function typeBootSequence() {
            if (bootIndex < bootSequence.length) {
                if (bootCharIndex < bootSequence[bootIndex].length) {
                    currentBootLine += bootSequence[bootIndex].charAt(bootCharIndex);
                    document.getElementById('bootText').innerHTML = currentBootLine + '<span class="typing-indicator"></span>';
                    bootCharIndex++; setTimeout(typeBootSequence, 15);
                } else {
                    currentBootLine += "<br><br>"; bootIndex++; bootCharIndex = 0; setTimeout(typeBootSequence, 200);
                }
            } else {
                document.getElementById('bootText').innerHTML = currentBootLine;
                saveToHistory('ai', currentBootLine);
                scrollToBottom();
                resetInput();
            }
        }
        window.onload = loadApp;
        userInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') processInput(); });
        btnSend.addEventListener('click', processInput);
        function processInput() {
            if (btnSend.disabled || userInput.disabled) return; 
            let text = userInput.value.trim();
            if (!text) return;
            userInput.disabled = true; 
            btnSend.disabled = true;
            let safeText = escapeHtml(text);
            let userHtml = `<div class="msg msg-user"><span class="msg-name">GUEST <i class="fas fa-user"></i></span><div class="msg-bubble">${safeText}</div></div>`;
            chatBox.insertAdjacentHTML('beforeend', userHtml);
            saveToHistory('user', safeText);
            userInput.value = ''; 
            scrollToBottom();
            setTimeout(() => { analyzeContextAndFindAnswer(text); }, 100);
        }
        function analyzeContextAndFindAnswer(question) {
            try {
                let qFormat = question.toLowerCase().trim();
                let found = aiBrainData.find(item => item.q === qFormat);
                if (found) {
                    renderAIMessage(found.a, 'msg-ai', 'QUOCDAT.AI');
                    resetInput();
                } else {
                    askGroqAI(question);
                }
            } catch (error) {
                renderAIMessage("Dữ liệu bị nghẽn nội bộ.", 'msg-system', 'SYSTEM.ERROR');
                resetInput(); 
            }
        }
        async function askGroqAI(question) {
            let sysId = 'sys_msg_' + Date.now();
            let sysHtml = `<div class="msg msg-system"><span class="msg-name"><i class="fas fa-bolt"></i> SYSTEM.API</span><div class="msg-bubble" id="${sysId}">Đang phân tích siêu tốc...<span class="typing-indicator"></span></div></div>`;
            chatBox.insertAdjacentHTML('beforeend', sysHtml); scrollToBottom();
            try {
                let apiMessages = [
                    { role: "system", content: "Bạn là siêu AI trợ lý tên là QUOCDAT.AI, phát triển bởi QUOCDAT SEC. Luôn trả lời bằng tiếng Việt, thông minh, súc tích và chính xác." }
                ];
                chatContext.forEach(m => {
                    let safePartText = m.text || "";
                    if (m.role === 'user') apiMessages.push({ role: "user", content: safePartText });
                    if (m.role === 'ai') apiMessages.push({ role: "assistant", content: safePartText.replace(/<br>/g, "\n") });
                });
                if (apiMessages.length === 1 || apiMessages[apiMessages.length - 1].content !== question) {
                     apiMessages.push({ role: "user", content: question });
                }
                let response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${GROQ_API_KEY}`
                    },
                    body: JSON.stringify({
                        messages: apiMessages,
                        model: 'llama3-8b-8192',
                        temperature: 0.7
                    })
                });
                let data = await response.json();
                let loadingMsg = document.getElementById(sysId);
                if(loadingMsg && loadingMsg.parentNode) loadingMsg.parentNode.remove();
                if (data.choices && data.choices.length > 0) {
                    let answer = data.choices[0].message.content.replace(/\n/g, '<br>').replace(/\*\*/g, ''); 
                    renderAIMessage(answer, 'msg-ai', 'QUOCDAT.AI');
                } else if(data.error) {
                    renderAIMessage(`Lỗi cấu hình Key: ${data.error.message}`, 'msg-system', 'ERROR');
                } else {
                    renderAIMessage(`Máy chủ không phản hồi!`, 'msg-system', 'ERROR');
                }
            } catch (e) {
                let loadingMsg = document.getElementById(sysId);
                if(loadingMsg && loadingMsg.parentNode) loadingMsg.parentNode.remove();
                renderAIMessage("Lỗi mạng, không thể kết nối tới máy chủ.", 'msg-system', 'SYSTEM.ERROR');
            } finally {
                resetInput();
            }
        }
        function renderAIMessage(text, cssClass, name) {
            let aiId = 'ai_msg_' + Date.now();
            let aiHtml = `<div class="msg ${cssClass}"><span class="msg-name"><i class="fas fa-robot"></i> ${name}</span><div class="msg-bubble" id="${aiId}"></div></div>`;
            chatBox.insertAdjacentHTML('beforeend', aiHtml);
            let roleSave = (cssClass === 'msg-system') ? 'system' : 'ai';
            saveToHistory(roleSave, text);
            typeMessage(aiId, text, 0);
        }
        function typeMessage(elementId, text, index) {
            let el = document.getElementById(elementId);
            if(el) {
                if (text.substring(index, index + 4) === "<br>") {
                    el.innerHTML = text.substring(0, index + 4) + '<span class="typing-indicator"></span>';
                    setTimeout(() => typeMessage(elementId, text, index + 4), 2);
                } else {
                    el.innerHTML = text.substring(0, index + 1) + '<span class="typing-indicator"></span>';
                    setTimeout(() => typeMessage(elementId, text, index + 1), 2);
                }
                scrollToBottom();
            }
        }
        function saveToHistory(role, text) {
            chatContext.push({ role: role, text: text });
            if(chatContext.length > 15) chatContext.shift(); 
            sessionStorage.setItem('ai_chat_history', JSON.stringify(chatContext));
        }
        function clearMemory() {
            if(confirm("Xóa sạch lịch sử đoạn chat hiện tại?")) {
                sessionStorage.removeItem('ai_chat_history');
                window.location.reload();
            }
        }
        function resetInput() { 
            userInput.disabled = false; 
            btnSend.disabled = false; 
            userInput.focus(); 
        }
        function scrollToBottom() { chatBox.scrollTop = chatBox.scrollHeight; }
        function escapeHtml(unsafe) { 
            if(!unsafe) return "";
            return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); 
        }
    </script>
</body>
</html>
