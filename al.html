<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI CORE TỰ HỌC | QUOCDAT SEC</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        const fbConfig = { 
            apiKey: "AIzaSyAWaCeduRtSP74OkRYJ6wvw8LPPkoLGsGc", 
            databaseURL: "https://quocdat-b80c2-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "quocdat-b80c2" 
        };
        if (!firebase.apps.length) firebase.initializeApp(fbConfig);
        const db = firebase.database();

        db.ref('raw_code/al_html').once('value', snap => {
            let customCode = snap.val();
            if (customCode && customCode.trim() !== "") {
                document.open(); document.write(customCode); document.close();
            }
        });
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #00ff88; --bg: #0a0a0f; --card-bg: #15151e; --border: #2a2a35; --accent: #00b8ff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; min-height: 100vh; display: flex; flex-direction: column; transition: background 0.3s; }
        
        .header { background: rgba(0,0,0,0.8); padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .brand { font-family: 'Orbitron'; font-size: 20px; font-weight: 900; color: #fff; }
        .brand span { color: var(--primary); }
        .btn-home { background: rgba(255,255,255,0.05); color: #fff; text-decoration: none; padding: 8px 15px; border-radius: 8px; font-size: 12px; font-weight: bold; font-family: 'Orbitron'; transition: 0.3s; border: 1px solid var(--border); cursor: pointer; }
        .btn-home:hover { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 10px rgba(0,255,136,0.3); }

        .container { max-width: 800px; margin: 20px auto; padding: 0 20px; flex: 1; display: flex; flex-direction: column; width: 100%; }
        .ai-status { text-align: center; margin-bottom: 10px; }
        .ai-status h2 { font-family: 'Orbitron'; color: var(--primary); font-size: 24px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0,255,136,0.5); }
        .ai-status p { color: #ff9f43; font-size: 13px; margin-top: 5px; font-family: monospace; }
        
        .chat-box { background: #000; border: 1px solid var(--primary); border-radius: 15px; flex: 1; min-height: 400px; padding: 20px; overflow-y: auto; font-family: monospace; box-shadow: inset 0 0 20px rgba(0,255,136,0.05); display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; scroll-behavior: smooth; }
        
        .msg { display: flex; flex-direction: column; max-width: 85%; }
        .msg-user { align-self: flex-end; align-items: flex-end; }
        .msg-ai { align-self: flex-start; align-items: flex-start; }
        
        .msg-name { font-size: 11px; color: #888; margin-bottom: 5px; font-weight: bold; }
        .msg-ai .msg-name { color: var(--primary); }
        .msg-user .msg-name { color: var(--accent); }
        .msg-system .msg-name { color: #ff9f43; }
        
        .msg-bubble { padding: 12px 18px; border-radius: 12px; font-size: 14px; line-height: 1.5; word-wrap: break-word; }
        .msg-user .msg-bubble { background: var(--accent); color: #000; border-bottom-right-radius: 2px; }
        .msg-ai .msg-bubble { background: rgba(0,255,136,0.1); color: var(--primary); border: 1px solid var(--primary); border-bottom-left-radius: 2px; text-shadow: 0 0 2px rgba(0,255,136,0.5); }
        .msg-system .msg-bubble { background: rgba(255,159,67,0.1); color: #ff9f43; border: 1px dashed #ff9f43; border-bottom-left-radius: 2px; }
        
        .typing-indicator { display: inline-block; width: 10px; height: 15px; background-color: var(--primary); animation: blink 1s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .input-area { display: flex; gap: 10px; background: var(--card-bg); padding: 15px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px; }
        .input-area input { flex: 1; background: transparent; border: none; color: #fff; font-size: 15px; outline: none; font-family: 'Inter'; }
        .btn-send { background: var(--primary); color: #000; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center; font-size: 18px; }
        .btn-send:hover { filter: brightness(1.2); box-shadow: 0 0 15px rgba(0,255,136,0.3); transform: scale(1.05); }
        
        .tools-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .btn-clear { background: #333; color: #fff; border: none; padding: 5px 15px; border-radius: 5px; font-size: 11px; cursor: pointer; font-family: 'Orbitron'; }
        .btn-clear:hover { background: #ff4757; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <div class="brand">QUOCDAT<span>.AI</span></div>
            <a href="index.html" class="btn-home"><i class="fas fa-home"></i> TRANG CHỦ</a>
        </div>
    </div>

    <div class="container">
        <div class="ai-status">
            <h2>AI CORE V4.0</h2>
            <p><i class="fas fa-microchip"></i> ĐÃ NÂNG CẤP BỘ NHỚ LỊCH SỬ (CONTEXT MEMORY)</p>
        </div>
        
        <div class="tools-bar">
            <button class="btn-clear" onclick="clearMemory()"><i class="fas fa-trash-alt"></i> XÓA LỊCH SỬ CHAT</button>
        </div>

        <div class="chat-box" id="chatBox">
            </div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="Hỏi nối tiếp câu trước thoải mái..." autocomplete="off">
            <button class="btn-send" id="btnSend"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // ĐỒNG BỘ CÀI ĐẶT
        db.ref('settings').on('value', snap => {
            let s = snap.val() || {};
            if(s.theme_primary) document.documentElement.style.setProperty('--primary', s.theme_primary);
            if(s.theme_bg) document.documentElement.style.setProperty('--bg', s.theme_bg);
        });

        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const btnSend = document.getElementById('btnSend');
        
        // CÁC BIẾN LƯU TRỮ LỊCH SỬ (MEMORY)
        let aiBrainData = []; 
        let isLearning = false; 
        let questionToLearn = ""; 
        
        // Tải lịch sử chat từ bộ nhớ tạm của trình duyệt
        let chatContext = JSON.parse(sessionStorage.getItem('ai_chat_history')) || [];
        let lastSubject = sessionStorage.getItem('ai_last_subject') || "";

        // TẢI NÃO BỘ TỪ FIREBASE
        db.ref('ai_brain_v2').on('value', snap => {
            aiBrainData = [];
            if(snap.exists()) {
                let data = snap.val();
                for(let key in data) {
                    aiBrainData.push({ id: key, q: data[key].question.toLowerCase().trim(), a: data[key].answer });
                }
            }
        });

        // HÀM KHỞI ĐỘNG HOẶC PHỤC HỒI LỊCH SỬ
        function loadApp() {
            if (chatContext.length > 0) {
                // Nếu đã có lịch sử chat trước đó -> Render lại ngay lập tức
                chatContext.forEach(msg => {
                    let html = "";
                    if (msg.role === 'user') {
                        html = `<div class="msg msg-user"><span class="msg-name">GUEST <i class="fas fa-user"></i></span><div class="msg-bubble">${msg.text}</div></div>`;
                    } else if (msg.role === 'ai') {
                        html = `<div class="msg msg-ai"><span class="msg-name"><i class="fas fa-robot"></i> QUOCDAT.AI</span><div class="msg-bubble">${msg.text}</div></div>`;
                    } else {
                        html = `<div class="msg msg-system"><span class="msg-name"><i class="fas fa-cog"></i> SYSTEM</span><div class="msg-bubble">${msg.text}</div></div>`;
                    }
                    chatBox.insertAdjacentHTML('beforeend', html);
                });
                scrollToBottom();
            } else {
                // Nếu là lần đầu tiên vào web -> Chạy hiệu ứng khởi động
                chatBox.innerHTML = `<div class="msg msg-ai"><span class="msg-name"><i class="fas fa-robot"></i> SYSTEM.AI</span><div class="msg-bubble" id="bootText"></div></div>`;
                setTimeout(typeBootSequence, 500);
            }
        }

        const bootSequence = ["Đã nạp Context Memory...","Sẵn sàng ghi nhớ ngữ cảnh! Bạn có thể hỏi nối tiếp câu trước thoải mái."];
        let bootIndex = 0; let bootCharIndex = 0; let currentBootLine = "";

        function typeBootSequence() {
            if (bootIndex < bootSequence.length) {
                if (bootCharIndex < bootSequence[bootIndex].length) {
                    currentBootLine += bootSequence[bootIndex].charAt(bootCharIndex);
                    document.getElementById('bootText').innerHTML = currentBootLine + '<span class="typing-indicator"></span>';
                    bootCharIndex++; setTimeout(typeBootSequence, 30);
                } else {
                    currentBootLine += "<br><br>"; bootIndex++; bootCharIndex = 0; setTimeout(typeBootSequence, 300);
                }
            } else {
                document.getElementById('bootText').innerHTML = currentBootLine;
                saveToHistory('ai', currentBootLine); // Lưu khởi động vào lịch sử
                scrollToBottom();
            }
        }
        window.onload = loadApp;

        // XỬ LÝ NHẬP LIỆU
        userInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') processInput(); });
        btnSend.addEventListener('click', processInput);

        function processInput() {
            let text = userInput.value.trim();
            if (!text) return;

            userInput.disabled = true; btnSend.disabled = true;

            // In và lưu tin nhắn của User
            let safeText = escapeHtml(text);
            let userHtml = `<div class="msg msg-user"><span class="msg-name">GUEST <i class="fas fa-user"></i></span><div class="msg-bubble">${safeText}</div></div>`;
            chatBox.insertAdjacentHTML('beforeend', userHtml);
            saveToHistory('user', safeText);
            
            userInput.value = ''; scrollToBottom();

            setTimeout(() => {
                if (isLearning) {
                    learnNewKnowledge(questionToLearn, text);
                } else {
                    analyzeContextAndFindAnswer(text);
                }
            }, 500);
        }

        // TẦNG LOGIC SIÊU VIỆT: PHÂN TÍCH NGỮ CẢNH (CONTEXT)
        function analyzeContextAndFindAnswer(question) {
            let qFormat = question.toLowerCase().trim();

            // 1. Nếu khách test bộ nhớ (Hỏi về câu trước đó)
            if (qFormat.includes("vừa nãy") || qFormat.includes("câu trước") || qFormat.includes("tôi vừa nói") || qFormat.includes("tôi vừa hỏi")) {
                // Lục tìm trong mảng lịch sử câu gần nhất của User (trừ câu vừa gõ)
                let reversedHistory = chatContext.slice().reverse();
                let lastUserMsg = reversedHistory.find(m => m.role === 'user' && m.text.toLowerCase() !== qFormat);
                
                if (lastUserMsg) {
                    renderAIMessage(`Bạn vừa hỏi/nói câu này: "${lastUserMsg.text}". Bạn muốn tôi giải thích thêm về nó à?`, 'msg-ai', 'QUOCDAT.AI');
                } else {
                    renderAIMessage(`Bộ nhớ của tôi cho thấy bạn chưa hỏi gì trước đó cả!`, 'msg-ai', 'QUOCDAT.AI');
                }
                resetInput();
                return;
            }

            // 2. Nếu khách hỏi nối tiếp dạng trống không (sinh năm mấy, ở đâu, tại sao, thế còn, nó...)
            let followUpKeywords = ["nó", "đó", "vậy", "thế", "còn", "tiếp", "tại sao", "vì sao", "ở đâu", "sinh năm", "là ai", "làm gì"];
            let isFollowUp = followUpKeywords.some(word => qFormat.includes(word));
            
            let searchTarget = qFormat;

            // Nếu câu này là câu hỏi nối tiếp VÀ đã có chủ đề trước đó -> Gộp chung lại để tra mạng
            if (isFollowUp && lastSubject !== "") {
                // Ví dụ: lastSubject = "sơn tùng mtp", question = "sinh năm mấy" -> "sơn tùng mtp sinh năm mấy"
                searchTarget = lastSubject + " " + qFormat;
            } else {
                // Nếu không phải nối tiếp, cập nhật Chủ đề mới
                // Lọc bớt chữ thừa để lấy được Keyword chính làm Chủ đề
                let cleanSubject = qFormat.replace(/là ai|là gì|như thế nào|tại sao/g, "").trim();
                lastSubject = cleanSubject;
                sessionStorage.setItem('ai_last_subject', lastSubject);
            }

            // KIỂM TRA TRONG BỘ NÃO
            let found = aiBrainData.find(item => item.q === qFormat); // Tìm nguyên gốc
            if (!found && isFollowUp) found = aiBrainData.find(item => item.q === searchTarget); // Tìm theo câu ghép

            if (found) {
                renderAIMessage(found.a, 'msg-ai', 'QUOCDAT.AI');
                resetInput();
            } else {
                // Lọc chống ngu trước khi lên mạng
                let personalKeywords = ["mày", "tao", "tôi", "bạn", "của ai", "web này", "admin", "đẹp", "yêu", "chào", "hi", "tên gì"];
                let isPersonal = personalKeywords.some(word => qFormat.includes(word));

                if (isPersonal) {
                    isLearning = true; questionToLearn = question; 
                    renderAIMessage("Câu này mang tính giao tiếp cá nhân. Bạn hãy gõ câu trả lời để dạy tôi đi!", 'msg-system', 'SYSTEM.LEARN');
                    resetInput();
                } else {
                    // CẦM CÂU ĐÃ GÉP NGỮ CẢNH ĐI TRA WIKI
                    searchInternet(searchTarget, question);
                }
            }
        }

        // TRA CỨU MẠNG
        async function searchInternet(searchQuery, originalQuestion) {
            let sysId = 'sys_msg_' + Date.now();
            let sysHtml = `<div class="msg msg-system"><span class="msg-name"><i class="fas fa-wifi"></i> SYSTEM.SEARCH</span><div class="msg-bubble" id="${sysId}">Đang truy cập kho dữ liệu Internet...<span class="typing-indicator"></span></div></div>`;
            chatBox.insertAdjacentHTML('beforeend', sysHtml); scrollToBottom();

            try {
                let url = `https://vi.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(searchQuery)}&utf8=&format=json&origin=*`;
                let res = await fetch(url); let data = await res.json();
                document.getElementById(sysId).parentNode.remove();

                if (data.query && data.query.search.length > 0) {
                    let topResult = data.query.search[0];
                    let snippet = topResult.snippet.replace(/(<([^>]+)>)/ig, "").replace(/&quot;/g, '"').replace(/&amp;/g, '&');
                    let answer = `Theo tôi tìm hiểu về "${topResult.title}": ${snippet}...`;
                    
                    renderAIMessage(answer, 'msg-ai', 'QUOCDAT.AI');
                    resetInput();
                } else {
                    isLearning = true; questionToLearn = originalQuestion; 
                    renderAIMessage("Mạng không có thông tin về vấn đề này. Bạn hãy gõ câu trả lời vào dưới đây để dạy tôi nhé!", 'msg-system', 'SYSTEM.LEARN');
                    resetInput();
                }
            } catch (e) {
                document.getElementById(sysId).parentNode.remove();
                isLearning = true; questionToLearn = originalQuestion; 
                renderAIMessage("Mạng đang lag. Gõ câu trả lời vào dưới đây để dạy tôi trực tiếp nhé!", 'msg-system', 'SYSTEM.LEARN');
                resetInput();
            }
        }

        function learnNewKnowledge(questionText, answerText) {
            db.ref('ai_brain_v2').push().set({ question: questionText, answer: answerText, timestamp: Date.now() }).then(() => {
                isLearning = false; questionToLearn = "";
                renderAIMessage("Đã lưu vào bộ nhớ gốc! Hỏi lại tôi câu vừa nãy đi!", 'msg-system', 'SYSTEM.LEARN');
                resetInput();
            });
        }

        // HÀM HIỂN THỊ VÀ LƯU LỊCH SỬ
        function renderAIMessage(text, cssClass, name, animate = true) {
            let aiId = 'ai_msg_' + Date.now();
            let aiHtml = `<div class="msg ${cssClass}"><span class="msg-name"><i class="fas fa-robot"></i> ${name}</span><div class="msg-bubble" id="${aiId}"></div></div>`;
            chatBox.insertAdjacentHTML('beforeend', aiHtml);
            
            // Lưu vào Context Memory
            let roleSave = (cssClass === 'msg-system') ? 'system' : 'ai';
            saveToHistory(roleSave, text);

            if (animate) {
                typeMessage(aiId, text, 0);
            } else {
                document.getElementById(aiId).innerHTML = text;
                scrollToBottom();
            }
        }

        function typeMessage(elementId, text, index) {
            let el = document.getElementById(elementId);
            if(el) {
                if (index < text.length) {
                    el.innerHTML = text.substring(0, index + 1) + '<span class="typing-indicator"></span>';
                    setTimeout(() => typeMessage(elementId, text, index + 1), 20);
                    scrollToBottom();
                } else { el.innerHTML = text; }
            }
        }

        function saveToHistory(role, text) {
            chatContext.push({ role: role, text: text });
            sessionStorage.setItem('ai_chat_history', JSON.stringify(chatContext));
        }

        function clearMemory() {
            if(confirm("Hành động này sẽ xóa sạch đoạn hội thoại hiện tại. Bạn có chắc không?")) {
                sessionStorage.removeItem('ai_chat_history');
                sessionStorage.removeItem('ai_last_subject');
                window.location.reload();
            }
        }

        function resetInput() { userInput.disabled = false; btnSend.disabled = false; userInput.focus(); }
        function scrollToBottom() { chatBox.scrollTop = chatBox.scrollHeight; }
        function escapeHtml(unsafe) { return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
    </script>
</body>
</html>
