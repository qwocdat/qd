<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI CORE V6.0 | QUOCDAT SEC</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #00ff88; --bg: #0a0a0f; --card-bg: #15151e; --border: #2a2a35; --accent: #00b8ff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; min-height: 100vh; display: flex; flex-direction: column; transition: background 0.3s; }
        
        .header { background: rgba(0,0,0,0.8); padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .brand { font-family: 'Orbitron'; font-size: 20px; font-weight: 900; color: #fff; }
        .brand span { color: var(--primary); }
        .btn-home { background: rgba(255,255,255,0.05); color: #fff; text-decoration: none; padding: 8px 15px; border-radius: 8px; font-size: 12px; font-weight: bold; font-family: 'Orbitron'; transition: 0.3s; border: 1px solid var(--border); cursor: pointer; }
        .btn-home:hover { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 10px rgba(0,255,136,0.3); }

        .container { max-width: 800px; margin: 20px auto; padding: 0 20px; flex: 1; display: flex; flex-direction: column; width: 100%; }
        .ai-status { text-align: center; margin-bottom: 10px; }
        .ai-status h2 { font-family: 'Orbitron'; color: var(--primary); font-size: 24px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0,255,136,0.5); }
        .ai-status p { color: #ff9f43; font-size: 13px; margin-top: 5px; font-family: monospace; }
        
        .chat-box { background: #000; border: 1px solid var(--primary); border-radius: 15px; flex: 1; min-height: 400px; padding: 20px; overflow-y: auto; font-family: monospace; box-shadow: inset 0 0 20px rgba(0,255,136,0.05); display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; scroll-behavior: smooth; }
        
        .msg { display: flex; flex-direction: column; max-width: 85%; }
        .msg-user { align-self: flex-end; align-items: flex-end; }
        .msg-ai { align-self: flex-start; align-items: flex-start; }
        
        .msg-name { font-size: 11px; color: #888; margin-bottom: 5px; font-weight: bold; }
        .msg-ai .msg-name { color: var(--primary); }
        .msg-user .msg-name { color: var(--accent); }
        .msg-system .msg-name { color: #ff9f43; }
        
        .msg-bubble { padding: 12px 18px; border-radius: 12px; font-size: 14px; line-height: 1.5; word-wrap: break-word; }
        .msg-user .msg-bubble { background: var(--accent); color: #000; border-bottom-right-radius: 2px; }
        .msg-ai .msg-bubble { background: rgba(0,255,136,0.1); color: var(--primary); border: 1px solid var(--primary); border-bottom-left-radius: 2px; text-shadow: 0 0 2px rgba(0,255,136,0.5); }
        .msg-system .msg-bubble { background: rgba(255,159,67,0.1); color: #ff9f43; border: 1px dashed #ff9f43; border-bottom-left-radius: 2px; }
        
        .typing-indicator { display: inline-block; width: 10px; height: 15px; background-color: var(--primary); animation: blink 1s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        .input-area { display: flex; gap: 10px; background: var(--card-bg); padding: 15px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px; }
        .input-area input { flex: 1; background: transparent; border: none; color: #fff; font-size: 15px; outline: none; font-family: 'Inter'; }
        .btn-send { background: var(--primary); color: #000; border: none; width: 45px; height: 45px; border-radius: 10px; cursor: pointer; transition: 0.3s; display: flex; justify-content: center; align-items: center; font-size: 18px; }
        .btn-send:hover { filter: brightness(1.2); box-shadow: 0 0 15px rgba(0,255,136,0.3); transform: scale(1.05); }
        
        .tools-bar { display: flex; justify-content: center; gap: 10px; margin-bottom: 10px; }
        .btn-clear { background: #333; color: #fff; border: none; padding: 5px 15px; border-radius: 5px; font-size: 11px; cursor: pointer; font-family: 'Orbitron'; }
        .btn-clear:hover { background: #ff4757; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-left">
            <div class="brand">QUOCDAT<span>.AI</span></div>
            <a href="index.html" class="btn-home"><i class="fas fa-home"></i> TRANG CH·ª¶</a>
        </div>
    </div>

    <div class="container">
        <div class="ai-status">
            <h2>AI CORE V6.0</h2>
            <p><i class="fas fa-satellite-dish"></i> T√çCH H·ª¢P GOOGLE GEMINI (MI·ªÑN PH√ç)</p>
        </div>
        
        <div class="tools-bar">
            <button class="btn-clear" onclick="clearMemory()"><i class="fas fa-trash-alt"></i> X√ìA L·ªäCH S·ª¨ CHAT</button>
        </div>

        <div class="chat-box" id="chatBox"></div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="H·ªèi AI b·∫•t c·ª© ƒëi·ªÅu g√¨ tr√™n th·∫ø gi·ªõi..." autocomplete="off">
            <button class="btn-send" id="btnSend"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
        // ==========================================
        // üîë API KEY GOOGLE GEMINI ƒê√É ƒê∆Ø·ª¢C T√çCH H·ª¢P
        // ==========================================
        const GEMINI_API_KEY = "AIzaSyCqt5-B4-brPMRHLOpP4OxgbnSc3XqBwWM"; 
        
        const fbConfig = { apiKey: "AIzaSyAWaCeduRtSP74OkRYJ6wvw8LPPkoLGsGc", databaseURL: "https://quocdat-b80c2-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "quocdat-b80c2" };
        if (!firebase.apps.length) firebase.initializeApp(fbConfig);
        const db = firebase.database();

        db.ref('settings').on('value', snap => {
            let s = snap.val() || {};
            if(s.theme_primary) document.documentElement.style.setProperty('--primary', s.theme_primary);
            if(s.theme_bg) document.documentElement.style.setProperty('--bg', s.theme_bg);
        });

        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        const btnSend = document.getElementById('btnSend');
        
        let aiBrainData = []; 
        let chatContext = JSON.parse(sessionStorage.getItem('ai_chat_history')) || [];

        // N√ÉO B·ªò N·ªòI B·ªò T·ª™ FIREBASE
        db.ref('ai_brain_v2').on('value', snap => {
            aiBrainData = [];
            if(snap.exists()) {
                let data = snap.val();
                for(let key in data) aiBrainData.push({ q: data[key].question.toLowerCase().trim(), a: data[key].answer });
            }
        });

        function loadApp() {
            if (chatContext.length > 0) {
                chatContext.forEach(msg => {
                    let html = "";
                    if (msg.role === 'user') html = `<div class="msg msg-user"><span class="msg-name">GUEST <i class="fas fa-user"></i></span><div class="msg-bubble">${msg.text}</div></div>`;
                    else if (msg.role === 'ai') html = `<div class="msg msg-ai"><span class="msg-name"><i class="fas fa-robot"></i> QUOCDAT.AI</span><div class="msg-bubble">${msg.text}</div></div>`;
                    else html = `<div class="msg msg-system"><span class="msg-name"><i class="fas fa-cog"></i> SYSTEM</span><div class="msg-bubble">${msg.text}</div></div>`;
                    chatBox.insertAdjacentHTML('beforeend', html);
                });
                scrollToBottom();
            } else {
                chatBox.innerHTML = `<div class="msg msg-ai"><span class="msg-name"><i class="fas fa-robot"></i> SYSTEM.AI</span><div class="msg-bubble" id="bootText"></div></div>`;
                setTimeout(typeBootSequence, 500);
            }
        }

        const bootSequence = ["Kh·ªüi ƒë·ªông B·ªô nh·ªõ K√©p...", "ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng v·ªõi Google Gemini API!", "T√¥i l√† tr·ª£ l√Ω AI th√¥ng minh c·ªßa b·∫°n. H√£y h·ªèi t√¥i ƒëi!"];
        let bootIndex = 0; let bootCharIndex = 0; let currentBootLine = "";

        function typeBootSequence() {
            if (bootIndex < bootSequence.length) {
                if (bootCharIndex < bootSequence[bootIndex].length) {
                    currentBootLine += bootSequence[bootIndex].charAt(bootCharIndex);
                    document.getElementById('bootText').innerHTML = currentBootLine + '<span class="typing-indicator"></span>';
                    bootCharIndex++; setTimeout(typeBootSequence, 30);
                } else {
                    currentBootLine += "<br><br>"; bootIndex++; bootCharIndex = 0; setTimeout(typeBootSequence, 300);
                }
            } else {
                document.getElementById('bootText').innerHTML = currentBootLine;
                saveToHistory('ai', currentBootLine);
                scrollToBottom();
            }
        }
        window.onload = loadApp;

        userInput.addEventListener('keypress', function (e) { if (e.key === 'Enter') processInput(); });
        btnSend.addEventListener('click', processInput);

        function processInput() {
            let text = userInput.value.trim();
            if (!text) return;

            userInput.disabled = true; btnSend.disabled = true;

            let safeText = escapeHtml(text);
            let userHtml = `<div class="msg msg-user"><span class="msg-name">GUEST <i class="fas fa-user"></i></span><div class="msg-bubble">${safeText}</div></div>`;
            chatBox.insertAdjacentHTML('beforeend', userHtml);
            saveToHistory('user', safeText);
            
            userInput.value = ''; scrollToBottom();

            setTimeout(() => { analyzeContextAndFindAnswer(text); }, 500);
        }

        function analyzeContextAndFindAnswer(question) {
            let qFormat = question.toLowerCase().trim();

            // 1. KI·ªÇM TRA N√ÉO FIREBASE TR∆Ø·ªöC
            let found = aiBrainData.find(item => item.q === qFormat);
            
            if (found) {
                renderAIMessage(found.a, 'msg-ai', 'QUOCDAT.AI');
                resetInput();
            } else {
                // 2. KH√îNG C√ì TRONG FIREBASE -> G·ªåI GOOGLE GEMINI
                askGemini(question);
            }
        }

        // K·∫æT N·ªêI API GOOGLE GEMINI
        async function askGemini(question) {
            let sysId = 'sys_msg_' + Date.now();
            let sysHtml = `<div class="msg msg-system"><span class="msg-name"><i class="fas fa-satellite-dish"></i> SYSTEM.API</span><div class="msg-bubble" id="${sysId}">ƒêang h·ªèi b·ªô n√£o Google Gemini...<span class="typing-indicator"></span></div></div>`;
            chatBox.insertAdjacentHTML('beforeend', sysHtml); scrollToBottom();

            try {
                // ƒê√≥ng g√≥i l·ªãch s·ª≠ th√†nh format c·ªßa Gemini
                let geminiHistory = [];
                chatContext.forEach(m => {
                    if (m.role === 'user') geminiHistory.push({ role: "user", parts: [{ text: m.text }] });
                    if (m.role === 'ai') geminiHistory.push({ role: "model", parts: [{ text: m.text.replace(/<br>/g, "\n") }] });
                });

                // ƒê·∫©y c√¢u h·ªèi hi·ªán t·∫°i v√†o
                if (geminiHistory.length === 0 || geminiHistory[geminiHistory.length - 1].parts[0].text !== question) {
                     geminiHistory.push({ role: "user", parts: [{ text: question }] });
                }

                // C·∫•u h√¨nh t√≠nh c√°ch AI
                let systemInstruction = {
                    parts: [{ text: "B·∫°n l√† si√™u AI tr·ª£ l√Ω t√™n l√† QUOCDAT.AI, ƒë∆∞·ª£c ph√°t tri·ªÉn b·ªüi h·ªá th·ªëng QUOCDAT SEC. H√£y tr·∫£ l·ªùi th√¢n thi·ªán, th√¥ng minh, d√πng ti·∫øng Vi·ªát Nam." }]
                };

                let apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
                
                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        system_instruction: systemInstruction,
                        contents: geminiHistory
                    })
                });

                let data = await response.json();
                document.getElementById(sysId).parentNode.remove();

                if (data.candidates && data.candidates.length > 0) {
                    let answer = data.candidates[0].content.parts[0].text;
                    // Format l·∫°i c√¢u tr·∫£ l·ªùi cho ƒë·∫πp
                    answer = answer.replace(/\n/g, '<br>').replace(/\*\*/g, ''); 
                    renderAIMessage(answer, 'msg-ai', 'QUOCDAT.AI');
                } else if (data.error) {
                    renderAIMessage(`L·ªói API Gemini: ${data.error.message}`, 'msg-system', 'ERROR');
                } else {
                    renderAIMessage(`AI kh√¥ng th·ªÉ tr·∫£ l·ªùi c√¢u n√†y!`, 'msg-system', 'ERROR');
                }
                resetInput();

            } catch (e) {
                document.getElementById(sysId).parentNode.remove();
                renderAIMessage("L·ªói k·∫øt n·ªëi API Google Gemini. Vui l√≤ng th·ª≠ l·∫°i sau.", 'msg-system', 'SYSTEM.ERROR');
                resetInput();
            }
        }

        function renderAIMessage(text, cssClass, name) {
            let aiId = 'ai_msg_' + Date.now();
            let aiHtml = `<div class="msg ${cssClass}"><span class="msg-name"><i class="fas fa-robot"></i> ${name}</span><div class="msg-bubble" id="${aiId}"></div></div>`;
            chatBox.insertAdjacentHTML('beforeend', aiHtml);
            
            let roleSave = (cssClass === 'msg-system') ? 'system' : 'ai';
            saveToHistory(roleSave, text);

            typeMessage(aiId, text, 0);
        }

        function typeMessage(elementId, text, index) {
            let el = document.getElementById(elementId);
            if(el) {
                if (text.substring(index, index + 4) === "<br>") {
                    el.innerHTML = text.substring(0, index + 4) + '<span class="typing-indicator"></span>';
                    setTimeout(() => typeMessage(elementId, text, index + 4), 5); // T·ªëc ƒë·ªô g√µ c·ª±c nhanh
                } else {
                    el.innerHTML = text.substring(0, index + 1) + '<span class="typing-indicator"></span>';
                    setTimeout(() =>
                        
