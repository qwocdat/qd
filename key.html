<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="pageTitle">XÁC THỰC PHIÊN | QUOCDAT SEC</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        const fbConfig = { 
            apiKey: "AIzaSyAWaCeduRtSP74OkRYJ6wvw8LPPkoLGsGc", 
            databaseURL: "https://quocdat-b80c2-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "quocdat-b80c2" 
        };
        if (!firebase.apps.length) firebase.initializeApp(fbConfig);
        const db = firebase.database();

        firebase.database().ref('raw_code/key_html').once('value', snap => {
            let customCode = snap.val();
            if (customCode && customCode.trim() !== "") {
                document.open(); document.write(customCode); document.close();
            }
        });
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #00ff88; --bg: #0a0a0f; --card-bg: #15151e; --border: #2a2a35; --accent: #00b8ff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { 
            background: var(--bg); color: #fff; 
            display: flex; align-items: center; justify-content: center; 
            min-height: 100vh; padding: 20px; 
        }
        
        /* HIỆU ỨNG LOADING KHI ĐANG KIỂM TRA BẢO MẬT */
        #securityGuard { text-align: center; }
        .guard-icon { font-size: 50px; color: var(--primary); margin-bottom: 20px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* GIAO DIỆN CHÍNH (MẶC ĐỊNH ẨN) */
        .card { 
            background: var(--card-bg); border: 1px solid var(--border); 
            width: 100%; max-width: 500px; padding: 40px 30px; 
            border-radius: 24px; text-align: center; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            display: none; 
        }
        
        .title { font-family: 'Orbitron', sans-serif; color: var(--primary); font-size: 24px; margin-bottom: 10px; }
        .subtitle { color: #888; font-size: 14px; margin-bottom: 25px; }
        
        select { 
            width: 100%; background: #000; color: #fff; 
            border: 1px solid var(--border); padding: 16px; 
            border-radius: 12px; margin-bottom: 20px; 
            font-size: 16px; outline: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2300ff88%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 16px top 50%; background-size: 12px auto;
        }
        
        .k-box { 
            display: none; background: rgba(0,255,136,0.1); 
            border: 2px dashed var(--primary); padding: 25px; 
            border-radius: 12px; margin: 25px 0; 
        }
        
        .key-value { font-family: 'Orbitron', sans-serif; font-size: 26px; color: #f1c40f; letter-spacing: 1px; font-weight: 900; word-break: break-all; }
        
        .btn { 
            background: var(--primary); color: #000; padding: 18px; width: 100%; border-radius: 12px; 
            border: none; font-weight: 900; font-family: 'Orbitron'; 
            cursor: pointer; transition: 0.3s; font-size: 16px; 
            text-decoration: none; display: inline-block;
        }
        .btn:hover:not(:disabled) { filter: brightness(1.2); transform: translateY(-2px); }
        .btn:disabled { background: #333; color: #777; cursor: not-allowed; }
        
        .timer-display { color: #ff4757; font-weight: 900; font-family: 'Orbitron'; margin-top: 15px; font-size: 18px; display: none; }
        .note { font-size: 12px; color: #555; margin-top: 15px; line-height: 1.5; }
    </style>
</head>
<body>

    <div id="securityGuard">
        <i class="fas fa-shield-alt guard-icon"></i>
        <p id="guardStatus">Đang xác thực phiên bảo mật...</p>
    </div>

    <div class="card" id="mainContent">
        <h2 class="title"><i class="fas fa-key"></i> NHẬN KEY</h2>
        
        <div id="setupArea">
            <p class="subtitle">Chọn công cụ và nhấn nút để tạo mã Key sử dụng.</p>
            <select id="productSelect">
                <option value="">-- Đang tải dữ liệu --</option>
            </select>
            <button class="btn" id="genBtn" onclick="generateKey()">KHỞI TẠO KEY NGAY</button>
        </div>

        <div id="resultArea" style="display:none;">
            <div class="k-box" style="display:block;">
                <p style="font-size: 12px; color: #888; margin-bottom: 10px;">MÃ KEY CỦA BẠN:</p>
                <span id="keyValue" class="key-value"></span>
            </div>
            <p id="expiryTimer" class="timer-display"></p>
            <a href="download.html" class="btn" style="background:#1e90ff; color:#fff; margin-top: 20px;"><i class="fas fa-download"></i> ĐẾN TRANG TẢI XUỐNG</a>
            <p class="note">Lưu ý: Nếu bạn tải lại trang này, phiên làm việc sẽ bị hủy vì lý do bảo mật.</p>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let token = urlParams.get('verify') || localStorage.getItem('qd_secure_token');

        // KIỂM TRA QUYỀN TRUY CẬP NGAY LÚC ĐẦU
        if (!token) {
            kickOut("Bạn không có quyền truy cập trực tiếp trang này!");
        } else {
            // Kiểm tra trạng thái Token trên Firebase
            db.ref('free_tokens/' + token).once('value', snapshot => {
                const data = snapshot.val();
                
                // CHỈ CHO PHÉP NẾU TRẠNG THÁI LÀ 'verified'
                if (!data || data.status !== 'verified') {
                    kickOut("Mã xác thực không hợp lệ hoặc đã được sử dụng!");
                } else {
                    // HỢP LỆ -> HIỂN THỊ GIAO DIỆN
                    showUI();
                }
            });
        }

        function kickOut(msg) {
            document.getElementById('guardStatus').innerText = msg + " Đang quay lại...";
            document.getElementById('guardStatus').style.color = "#ff4757";
            setTimeout(() => {
                window.location.replace("getkey.html");
            }, 2000);
        }

        function showUI() {
            document.getElementById('securityGuard').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadProducts();
            
            // Lắng nghe cài đặt màu từ Admin
            db.ref('settings').on('value', snap => {
                let s = snap.val() || {};
                if(s.theme_primary) document.documentElement.style.setProperty('--primary', s.theme_primary);
                if(s.theme_bg) document.documentElement.style.setProperty('--bg', s.theme_bg);
                if(s.site_name) document.title = "NHẬN KEY | " + s.site_name;
            });
        }

        function loadProducts() {
            db.ref('products').once('value', s => {
                let h = '<option value="">-- Chọn công cụ muốn lấy Key --</option>';
                s.forEach(c => { 
                    if(c.val().price === 0) h += `<option value="${c.key}">${c.val().name}</option>`; 
                });
                document.getElementById('productSelect').innerHTML = h;
            });
        }

        async function generateKey() {
            let pid = document.getElementById('productSelect').value;
            if(!pid) return alert("Vui lòng chọn 1 công cụ!");

            let genBtn = document.getElementById('genBtn');
            genBtn.disabled = true;
            genBtn.innerText = "ĐANG KHỞI TẠO...";

            // 1. TẠO KEY VÀ HẠN DÙNG (20 PHÚT)
            let key = "QDFREE-" + Math.random().toString(36).substring(2, 10).toUpperCase();
            let exp = Date.now() + 1200000;

            // 2. CẬP NHẬT TRẠNG THÁI TOKEN THÀNH 'active' (VÔ HIỆU HÓA VIỆC CHIA SẺ LINK)
            await db.ref('free_tokens/' + token).update({ 
                status: 'active', 
                key_granted: key,
                expiry_at: exp 
            });

            // 3. GHI LỊCH SỬ GIAO DỊCH
            let pSnap = await db.ref('products/' + pid).once('value');
            let pData = pSnap.val();
            await db.ref('transactions').push().set({
                user: 'Guest_' + token.substring(3, 8),
                type: 'free_key', amount: 0, detail: 'Dùng thử: ' + pData.name,
                key_granted: key, download_link: pData.download_link,
                expiry_at: exp, time: new Date().toISOString()
            });

            // 4. HIỂN THỊ KẾT QUẢ
            document.getElementById('setupArea').style.display = 'none';
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('keyValue').innerText = key;
            
            // Xóa mã khỏi bộ nhớ tạm để tránh dùng lại
            localStorage.removeItem('qd_secure_token');

            // 5. CHẠY BỘ ĐẾM NGƯỢC
            const timer = document.getElementById('expiryTimer');
            timer.style.display = 'block';
            let itv = setInterval(() => {
                let d = exp - Date.now();
                if(d <= 0) {
                    clearInterval(itv);
                    timer.innerText = "MÃ KEY ĐÃ HẾT HẠN!";
                    return;
                }
                let m = Math.floor(d / 60000);
                let s = Math.floor((d % 60000) / 1000);
                timer.innerText = `KEY HẾT HẠN SAU: ${m}:${s < 10 ? '0' : ''}${s}`;
            }, 1000);
        }
    </script>
</body>
</html>
