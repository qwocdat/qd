<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADMIN PANEL | QUOCDAT SEC</title>
    
    <script>
        // CỔNG BẢO MẬT ADMIN
        var isAdminLoggedIn = sessionStorage.getItem('admin_auth_status');
        if (isAdminLoggedIn !== 'success') {
            var password = prompt("⛔ HỆ THỐNG BẢO MẬT CẤP CAO\n\nVui lòng nhập mật khẩu Quản Trị Viên:");
            if (password === "ngdaiquocdat") {
                sessionStorage.setItem('admin_auth_status', 'success');
                alert("✅ Xác thực thành công! Chào mừng Admin.");
            } else {
                alert("❌ Mật khẩu sai! Truy cập bị từ chối.");
                window.location.replace("index.html");
            }
        }
        var currentUser = localStorage.getItem('vip_username') || 'admin_system';
        var safeUserId = currentUser.replace(/[.#$\[\]]/g, '_');

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function switchTab(tabId, el) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            let titles = {'dashboard':'TỔNG QUAN HỆ THỐNG', 'products':'QUẢN LÝ SẢN PHẨM', 'users':'QUẢN LÝ NGƯỜI DÙNG', 'history':'LỊCH SỬ GIAO DỊCH'};
            document.getElementById('pageTitle').innerText = titles[tabId];
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function logoutAdmin() { sessionStorage.removeItem('admin_auth_status'); window.location.replace('index.html'); }
        function showAdminToast(msg, isError = false) {
            let t = document.getElementById('toastMsg');
            t.style.borderLeftColor = isError ? '#ff4757' : '#00ff88';
            t.innerHTML = `<i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'}"></i> ${msg}`;
            t.classList.add('show');
            setTimeout(() => { t.classList.remove('show'); }, 3000);
        }
        function formatMoney(num) { return Number(num).toLocaleString('vi-VN') + " đ"; }
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #ff4757; --bg: #050508; --card-bg: #111; --border: #222; --accent: #00ff88; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; display: flex; height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #000; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        .sidebar { width: 260px; background: #0a0a0f; border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; z-index: 1000; }
        .brand { padding: 20px; font-family: 'Orbitron'; font-size: 20px; font-weight: 900; color: #fff; text-align: center; border-bottom: 1px solid var(--border); }
        .brand span { color: var(--primary); }
        .nav-menu { padding: 15px; flex: 1; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; color: #aaa; text-decoration: none; border-radius: 10px; margin-bottom: 5px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .nav-item.active { background: rgba(255,71,87,0.1); color: var(--primary); }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .topbar { height: 70px; background: rgba(10,10,15,0.9); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .content-area { padding: 20px; overflow-y: auto; flex: 1; }
        .tab-pane { display: none; } .tab-pane.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 15px; border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 20px; }
        
        .table-container { background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border); overflow-x: auto; margin-bottom: 20px; }
        .table-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .btn-add { background: var(--primary); color: #fff; padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #1a1a24; padding: 15px; text-align: left; font-size: 12px; color: #888; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        .action-btn { background: #222; border: 1px solid #333; color: #fff; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; margin-right: 5px; transition: 0.2s; }
        .action-btn.edit:hover { background: #1e90ff; border-color: #1e90ff; }
        .action-btn.money:hover { background: var(--accent); border-color: var(--accent); color: #000; }
        .action-btn.ban.is-banned { background: #ff4757; border-color: #ff4757; color: #fff; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 90%; max-width: 500px; background: #15151e; border-radius: 15px; border: 1px solid #333; overflow: hidden; }
        .modal-head { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #111; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto;}
        .form-group { margin-bottom: 15px; } 
        .form-group label { display: block; font-size: 12px; color: #aaa; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; background: #0a0a0f; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; outline: none; }
        .modal-footer { padding: 20px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 10px; background: #111; }
        
        .toast { position: fixed; bottom: 20px; right: -300px; background: #111; border-left: 4px solid var(--primary); color: #fff; padding: 15px 25px; border-radius: 8px; font-size: 13px; font-weight: bold; transition: 0.4s; z-index: 10000; }
        .toast.show { right: 20px; }
        .mobile-toggle { display: none; } 
        @media (max-width: 768px) { .sidebar { position: fixed; left: -260px; height: 100vh; } .sidebar.open { left: 0; } .mobile-toggle { display: block; } }
    </style>
</head>
<body>
        <div class="sidebar" id="sidebar">
        <div class="brand" style="display:flex; justify-content:space-between; align-items:center;">
            <div>QUOCDAT<span style="color:var(--primary)">.ADMIN</span></div>
            <i class="fas fa-times mobile-toggle" onclick="toggleSidebar()"></i>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-chart-pie"></i> Tổng Quan</div>
            <div class="nav-item" onclick="switchTab('products', this)"><i class="fas fa-box-open"></i> Quản Lý Sản Phẩm</div>
            <div class="nav-item" onclick="switchTab('users', this)"><i class="fas fa-users"></i> Quản Lý User & Khóa</div>
            <div class="nav-item" onclick="switchTab('history', this)"><i class="fas fa-history"></i> Lịch Sử Giao Dịch</div>
            
            <div class="nav-item" style="color:#ff4757; margin-top:20px; border-top:1px solid #222; padding-top:20px;" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</div>
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            <div style="display:flex; align-items:center; gap:15px;">
                <i class="fas fa-bars mobile-toggle" onclick="toggleSidebar()"></i>
                <div class="page-title" id="pageTitle">TỔNG QUAN HỆ THỐNG</div>
            </div>
            <a href="index.html" style="color:#fff; text-decoration:none; font-size:12px; border:1px solid #333; padding:8px 15px; border-radius:8px; background:#111;">Về Trang Chủ</a>
        </div>

        <div class="content-area">
            
            <div id="tab-dashboard" class="tab-pane active">
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:rgba(0,255,136,0.1); color:var(--accent);"><i class="fas fa-wallet"></i></div>
                        <div><div style="font-size:11px; color:#888;">TỔNG NẠP</div><div id="statRevenue" style="font-size:20px; font-weight:bold; font-family:'Orbitron';">0 đ</div></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:rgba(30,144,255,0.1); color:#1e90ff;"><i class="fas fa-users"></i></div>
                        <div><div style="font-size:11px; color:#888;">USER ĐĂNG KÝ</div><div id="statUsers" style="font-size:20px; font-weight:bold; font-family:'Orbitron';">0</div></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:rgba(255,71,87,0.1); color:var(--primary);"><i class="fas fa-box"></i></div>
                        <div><div style="font-size:11px; color:#888;">SẢN PHẨM</div><div id="statProducts" style="font-size:20px; font-weight:bold; font-family:'Orbitron';">0</div></div>
                    </div>
                </div>
            </div>

            <div id="tab-products" class="tab-pane">
                <div class="table-container">
                    <div class="table-header">
                        <h3>Kho Sản Phẩm Của Bạn</h3>
                        <button class="btn-add" onclick="openProductModal()"><i class="fas fa-plus"></i> Thêm Mới</button>
                    </div>
                    <table>
                        <thead><tr><th width="60">ID</th><th>Tên Sản Phẩm</th><th>Giá Bán</th><th width="100">Thao Tác</th></tr></thead>
                        <tbody id="productTableBody"><tr><td colspan="4" style="text-align:center;">Đang tải...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-users" class="tab-pane">
                <div class="table-container">
                    <div class="table-header"><h3>Danh Sách Người Dùng</h3></div>
                    <table>
                        <thead><tr><th>Tài Khoản</th><th>Số Dư</th><th>Trạng Thái</th><th width="120">Thao Tác</th></tr></thead>
                        <tbody id="userTableBody"><tr><td colspan="4" style="text-align:center;">Đang tải...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="tab-history" class="tab-pane">
                <div class="table-container">
                    <div class="table-header"><h3>Biến Động Dòng Tiền & Bán Hàng</h3></div>
                    <table>
                        <thead><tr><th>Thời Gian</th><th>Tài Khoản</th><th>Loại GD</th><th>Số Tiền</th><th>Chi Tiết / Mã KEY</th></tr></thead>
                        <tbody id="historyTableBody"><tr><td colspan="5" style="text-align:center;">Đang tải lịch sử...</td></tr></tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
        <div class="modal-overlay" id="productModal">
        <div class="modal-box">
            <div class="modal-head">
                <div class="modal-title" id="pModalTitle" style="color:var(--primary)">THÊM SẢN PHẨM</div>
                <button style="background:none; border:none; color:#fff;" onclick="closeModal('productModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pId">
                <div class="form-group"><label>Tên Sản Phẩm *</label><input type="text" id="pName"></div>
                <div class="form-group"><label>Danh Mục</label><select id="pCategory"><option value="Tool Social">Tool Social</option><option value="Script Game">Script Game</option><option value="Web Source">Mã Nguồn Web</option></select></div>
                <div class="form-group"><label>Giá Bán (VNĐ) *</label><input type="number" id="pPrice"></div>
                
                <div class="form-group"><label>Link Tải Sản Phẩm (Mediafire/Drive) *</label><input type="text" id="pDownload" placeholder="Nhập Link để khách tải sau khi mua..."></div>
                
                <div class="form-group"><label>Mô Tả Ngắn</label><textarea id="pDesc" rows="2"></textarea></div>
                <div class="form-group"><label>Icon (FontAwesome)</label><input type="text" id="pImg" value="fas fa-box"></div>
            </div>
            <div class="modal-footer">
                <button style="padding:10px 20px; border-radius:8px; border:none; background:#333; color:#fff;" onclick="closeModal('productModal')">Hủy</button>
                <button style="padding:10px 20px; border-radius:8px; border:none; background:var(--primary); font-weight:bold;" onclick="saveProduct()">LƯU</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="moneyModal">
        <div class="modal-box">
            <div class="modal-head"><div class="modal-title" style="color:var(--accent);">CẬP NHẬT SỐ DƯ</div><button style="background:none; border:none; color:#fff;" onclick="closeModal('moneyModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="uId">
                <div style="margin-bottom:15px; color:#fff;">Tài khoản: <strong id="uNameDisplay"></strong></div>
                <div class="form-group"><label>Nhập số dư mới (VNĐ) *</label><input type="number" id="uNewBalance"></div>
            </div>
            <div class="modal-footer"><button style="padding:10px 20px; border-radius:8px; border:none; background:#333; color:#fff;" onclick="closeModal('moneyModal')">Hủy</button><button style="padding:10px 20px; border-radius:8px; border:none; background:var(--accent); font-weight:bold;" onclick="saveUserBalance()">CẬP NHẬT</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="banModal">
        <div class="modal-box" style="border-color:#ff9f43;">
            <div class="modal-head" style="background:#2d1b00;">
                <div class="modal-title" style="color:#ff9f43;"><i class="fas fa-lock"></i> KHÓA TÀI KHOẢN</div>
                <button style="background:none; border:none; color:#fff;" onclick="closeModal('banModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="banUid">
                <div style="margin-bottom:15px; color:#fff;">Khóa user: <strong id="banNameDisplay" style="color:#ff9f43;"></strong></div>
                <div class="form-group"><label>Lý do khóa *</label><input type="text" id="banReason" placeholder="VD: Sử dụng Bug..."></div>
                <div class="form-group"><label>Khóa đến ngày giờ *</label><input type="datetime-local" id="banUntil"></div>
                <div id="banStatusDisplay" style="margin-top:10px; font-size:12px; color:#ff4757; font-weight:bold; display:none;">Tài khoản này đang bị khóa!</div>
            </div>
            <div class="modal-footer">
                <button id="btnUnbanBtn" style="padding:10px 20px; border-radius:8px; border:none; background:#222; color:var(--accent); font-weight:bold; display:none;" onclick="unbanUser()">MỞ KHÓA</button>
                <button style="padding:10px 20px; border-radius:8px; border:none; background:#ff9f43; font-weight:bold;" onclick="executeBan()">THỰC THI KHÓA</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toastMsg">Thành công!</div>
        <script>
        // FIREBASE INIT
        const firebaseConfig = { apiKey: "AIzaSyAWaCeduRtSP74OkRYJ6wvw8LPPkoLGsGc", databaseURL: "https://quocdat-b80c2-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "quocdat-b80c2" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. QUẢN LÝ SẢN PHẨM & LINK TẢI
        let currentProducts = {};
        db.ref('products').on('value', (s) => {
            let tbody = document.getElementById('productTableBody'); tbody.innerHTML = '';
            let pCount = 0;
            if(s.exists()) {
                currentProducts = s.val();
                for(let id in currentProducts) {
                    let p = currentProducts[id];
                    pCount++;
                    tbody.innerHTML += `<tr>
                        <td><strong style="color:var(--primary)">#${id.substring(0,4)}</strong></td>
                        <td style="font-weight:bold;">${p.name}</td>
                        <td style="color:var(--accent); font-weight:bold; font-family:monospace;">${formatMoney(p.price)}</td>
                        <td>
                            <button class="action-btn edit" onclick="openProductModal('${id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="deleteProduct('${id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }
            } else {
                tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Trống</td></tr>`;
            }
            document.getElementById('statProducts').innerText = pCount;
        });

        function openProductModal(id = null) {
            document.getElementById('pId').value = ''; document.getElementById('pName').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('pDesc').value = ''; document.getElementById('pDownload').value = '';
            if(id) {
                let p = currentProducts[id];
                document.getElementById('pId').value = id; document.getElementById('pName').value = p.name; document.getElementById('pPrice').value = p.price; document.getElementById('pCategory').value = p.category; document.getElementById('pDesc').value = p.desc || ''; document.getElementById('pImg').value = p.img || 'fas fa-box';
                // Đẩy dữ liệu Link tải cũ vào form (nếu có)
                document.getElementById('pDownload').value = p.download_link || '';
            }
            document.getElementById('productModal').style.display = 'flex';
        }

        function saveProduct() {
            let id = document.getElementById('pId').value;
            let data = { 
                name: document.getElementById('pName').value, 
                price: Number(document.getElementById('pPrice').value), 
                category: document.getElementById('pCategory').value, 
                desc: document.getElementById('pDesc').value, 
                img: document.getElementById('pImg').value,
                download_link: document.getElementById('pDownload').value // Lưu Link tải
            };
            if(!data.name || !data.price || !data.download_link) return alert("Điền đủ Tên, Giá và Link tải!");
            
            if(id) db.ref('products/' + id).update(data).then(() => { showAdminToast("Cập nhật SP xong"); closeModal('productModal'); });
            else db.ref('products').push().set(data).then(() => { showAdminToast("Đã thêm SP"); closeModal('productModal'); });
        }

        function deleteProduct(id) { if(confirm("Xóa sản phẩm này?")) db.ref('products/'+id).remove(); }

        // 2. QUẢN LÝ USER
        let currentUsers = {};
        db.ref('users').on('value', (s) => {
            let tbody = document.getElementById('userTableBody'); tbody.innerHTML = '';
            let uCount = 0, totalM = 0;
            if(s.exists()) {
                currentUsers = s.val();
                for(let id in currentUsers) {
                    let u = currentUsers[id];
                    uCount++; totalM += (u.balance || 0);
                    let isBanned = u.banned && new Date(u.ban_until).getTime() > new Date().getTime();
                    let statusHtml = isBanned ? `<span style="color:#ff4757; font-size:11px; font-weight:bold;"><i class="fas fa-lock"></i> Đã Khóa</span>` : `<span style="color:var(--accent); font-size:11px;"><i class="fas fa-check"></i> An Toàn</span>`;
                    
                    tbody.innerHTML += `<tr>
                        <td style="font-weight:bold;">${id.replace(/_/g, '.')}</td>
                        <td style="color:var(--accent); font-family:monospace; font-weight:bold;">${formatMoney(u.balance || 0)}</td>
                        <td>${statusHtml}</td>
                        <td>
                            <button class="action-btn money" onclick="openMoneyModal('${id}')"><i class="fas fa-coins"></i></button>
                            <button class="action-btn ban ${isBanned ? 'is-banned' : ''}" onclick="openBanModal('${id}')"><i class="fas fa-lock"></i></button>
                            <button class="action-btn delete" onclick="deleteUser('${id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }
            }
            document.getElementById('statUsers').innerText = uCount;
            document.getElementById('statRevenue').innerText = formatMoney(totalM);
        });

        function openMoneyModal(id) { document.getElementById('uId').value = id; document.getElementById('uNameDisplay').innerText = id.replace(/_/g, '.'); document.getElementById('uNewBalance').value = currentUsers[id].balance || 0; document.getElementById('moneyModal').style.display = 'flex'; }
        
        // HÀM NẠP TIỀN CÓ GHI LỊCH SỬ GIAO DỊCH
        function saveUserBalance() { 
            let id = document.getElementById('uId').value;
            let newBal = Number(document.getElementById('uNewBalance').value); 
            
            db.ref('users/'+id).update({balance: newBal}).then(() => { 
                showAdminToast("Cập nhật tiền xong"); 
                
                // Ghi vào bảng Lịch sử (Admin chủ động thay đổi tiền)
                db.ref('transactions').push().set({
                    user: id,
                    type: 'admin_update',
                    amount: newBal,
                    detail: 'Admin cập nhật số dư',
                    time: new Date().toISOString()
                });

                closeModal('moneyModal'); 
            }); 
        }

        function deleteUser(id) { if(confirm("XÓA TÀI KHOẢN? (Sẽ mất tiền của họ)")) db.ref('users/'+id).remove(); }

        // BAN HỆ THỐNG
        function openBanModal(id) {
            document.getElementById('banUid').value = id; document.getElementById('banNameDisplay').innerText = id.replace(/_/g, '.');
            let u = currentUsers[id];
            let now = new Date(); now.setHours(now.getHours() + 24); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('banUntil').value = now.toISOString().slice(0,16);
            document.getElementById('banReason').value = "";
            if(u.banned && new Date(u.ban_until).getTime() > new Date().getTime()) {
                document.getElementById('banStatusDisplay').style.display = 'block'; document.getElementById('btnUnbanBtn').style.display = 'block'; document.getElementById('banReason').value = u.ban_reason;
                let banD = new Date(u.ban_until); banD.setMinutes(banD.getMinutes() - banD.getTimezoneOffset()); document.getElementById('banUntil').value = banD.toISOString().slice(0,16);
            } else {
                document.getElementById('banStatusDisplay').style.display = 'none'; document.getElementById('btnUnbanBtn').style.display = 'none';
            }
            document.getElementById('banModal').style.display = 'flex';
        }

        function executeBan() {
            let id = document.getElementById('banUid').value, reason = document.getElementById('banReason').value || "Vi phạm quy định", until = document.getElementById('banUntil').value;
            if(!until) return alert("Chọn ngày mở khóa!");
            db.ref('users/'+id).update({ banned: true, ban_reason: reason, ban_until: new Date(until).toISOString() }).then(() => { showAdminToast("Đã Khóa User!", true); closeModal('banModal'); });
        }
        function unbanUser() {
            let id = document.getElementById('banUid').value;
            db.ref('users/'+id).update({ banned: false, ban_reason: null, ban_until: null }).then(() => { showAdminToast("Đã ân xá."); closeModal('banModal'); });
        }

        // 3. LOAD LỊCH SỬ GIAO DỊCH TOÀN HỆ THỐNG
        db.ref('transactions').orderByChild('time').on('value', (s) => {
            let tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            if(s.exists()) {
                let transList = [];
                s.forEach(child => { transList.push(child.val()); });
                transList.reverse(); // Đảo ngược để mới nhất lên đầu
                
                transList.forEach(t => {
                    let time = new Date(t.time).toLocaleString('vi-VN');
                    let uName = t.user.replace(/_/g, '.');
                    let color = t.type === 'purchase' ? '#ff4757' : 'var(--accent)';
                    let typeText = t.type === 'purchase' ? 'Mua Sản Phẩm' : 'Nạp / Cập Nhật';
                    
                    // Nếu là Mua sản phẩm, phần Chi tiết sẽ hiển thị KEY đã cấp
                    let detailHtml = t.detail;
                    if(t.type === 'purchase' && t.key_granted) {
                        detailHtml = `${t.detail}<br><span style="font-size:11px; color:#f1c40f; font-family:monospace;">KEY: ${t.key_granted}</span>`;
                    }

                    tbody.innerHTML += `<tr>
                        <td style="font-size:12px; color:#888;">${time}</td>
                        <td style="font-weight:bold;">${uName}</td>
                        <td><span style="background:rgba(255,255,255,0.1); padding:3px 8px; border-radius:5px; font-size:11px;">${typeText}</span></td>
                        <td style="color:${color}; font-weight:bold; font-family:monospace;">${t.type === 'purchase' ? '-' : '+'}${formatMoney(t.amount)}</td>
                        <td style="font-size:12px;">${detailHtml}</td>
                    </tr>`;
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Chưa có giao dịch nào phát sinh.</td></tr>`;
            }
        });
    </script>
</body>
</html>
    <script>
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function switchTab(tabId, element) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            let titles = {'dashboard':'TỔNG QUAN HỆ THỐNG', 'products':'QUẢN LÝ SẢN PHẨM', 'users':'QUẢN LÝ NGƯỜI DÙNG', 'history':'LỊCH SỬ GIAO DỊCH'};
            document.getElementById('pageTitle').innerText = titles[tabId];
        }
        function logoutAdmin() { sessionStorage.removeItem('admin_auth_status'); window.location.replace('index.html'); }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function formatMoney(num) { return Number(num).toLocaleString('vi-VN') + " đ"; }
        function showAdminToast(msg, isError = false) {
            let toast = document.getElementById('toastMsg');
            toast.style.borderLeftColor = isError ? '#ff4757' : '#00ff88';
            toast.innerHTML = `<i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'}"></i> ${msg}`;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        const firebaseConfig = { apiKey: "AIzaSyAWaCeduRtSP74OkRYJ6wvw8LPPkoLGsGc", databaseURL: "https://quocdat-b80c2-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "quocdat-b80c2" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. SẢN PHẨM
        let currentProducts = {};
        db.ref('products').on('value', (s) => {
            let tbody = document.getElementById('productTableBody'); tbody.innerHTML = '';
            let pCount = 0;
            if(s.exists()) {
                currentProducts = s.val();
                for(let id in currentProducts) {
                    let p = currentProducts[id]; pCount++;
                    let priceText = p.price > 0 ? formatMoney(p.price) : '<span style="color:var(--primary);">MIỄN PHÍ</span>';
                    tbody.innerHTML += `<tr>
                        <td><strong style="color:var(--primary)">#${id.substring(0,4)}</strong></td>
                        <td style="font-weight:bold;">${p.name}</td>
                        <td style="color:var(--accent); font-weight:bold; font-family:monospace;">${priceText}</td>
                        <td>
                            <button class="action-btn edit" onclick="openProductModal('${id}')"><i class="fas fa-edit"></i></button>
                            <button class="action-btn delete" onclick="deleteProduct('${id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }
            } else { tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Trống</td></tr>`; }
            document.getElementById('statProducts').innerText = pCount;
        });

        function openProductModal(id = null) {
            document.getElementById('pId').value = ''; document.getElementById('pName').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('pDesc').value = ''; document.getElementById('pDownload').value = '';
            if(id) {
                let p = currentProducts[id];
                document.getElementById('pId').value = id; document.getElementById('pName').value = p.name; document.getElementById('pPrice').value = p.price; document.getElementById('pCategory').value = p.category; document.getElementById('pDesc').value = p.desc || ''; document.getElementById('pImg').value = p.img || 'fas fa-box'; document.getElementById('pDownload').value = p.download_link || '';
            }
            document.getElementById('productModal').style.display = 'flex';
        }

        function saveProduct() {
            let id = document.getElementById('pId').value;
            let priceVal = document.getElementById('pPrice').value;
            let rawLink = document.getElementById('pDownload').value.trim();
            
            // BẢO VỆ LINK TẢI: NẾU ADMIN QUÊN GÕ HTTPS:// THÌ CODE SẼ TỰ ĐỘNG THÊM VÀO ĐỂ KHÔNG BỊ LỖI CHUYỂN TRANG
            if(rawLink !== "" && !rawLink.startsWith('http://') && !rawLink.startsWith('https://')) {
                rawLink = 'https://' + rawLink;
            }

            let data = { 
                name: document.getElementById('pName').value, price: priceVal !== "" ? Number(priceVal) : "", 
                category: document.getElementById('pCategory').value, desc: document.getElementById('pDesc').value, 
                img: document.getElementById('pImg').value, download_link: rawLink 
            };
            
            if(!data.name || data.price === "" || data.price === null || !data.download_link) return alert("Điền đủ Tên, Giá (nhập 0 nếu Free) và Link tải!");
            
            if(id) db.ref('products/' + id).update(data).then(() => { showAdminToast("Cập nhật SP xong"); closeModal('productModal'); });
            else db.ref('products').push().set(data).then(() => { showAdminToast("Đã thêm SP"); closeModal('productModal'); });
        }

        function deleteProduct(id) { if(confirm("Xóa sản phẩm này?")) db.ref('products/'+id).remove(); }

        // 2. USER
        let currentUsers = {};
        db.ref('users').on('value', (s) => {
            let tbody = document.getElementById('userTableBody'); tbody.innerHTML = ''; let uCount = 0, totalM = 0;
            if(s.exists()) {
                currentUsers = s.val();
                for(let id in currentUsers) {
                    let u = currentUsers[id]; uCount++; totalM += (u.balance || 0);
                    let isBanned = u.banned && new Date(u.ban_until).getTime() > new Date().getTime();
                    let statusHtml = isBanned ? `<span style="color:#ff4757; font-size:11px; font-weight:bold;"><i class="fas fa-lock"></i> Đã Khóa</span>` : `<span style="color:var(--accent); font-size:11px;"><i class="fas fa-check"></i> An Toàn</span>`;
                    tbody.innerHTML += `<tr>
                        <td style="font-weight:bold;">${id.replace(/_/g, '.')}</td>
                        <td style="color:var(--accent); font-family:monospace; font-weight:bold;">${formatMoney(u.balance || 0)}</td>
                        <td>${statusHtml}</td>
                        <td>
                            <button class="action-btn money" onclick="openMoneyModal('${id}')"><i class="fas fa-coins"></i></button>
                            <button class="action-btn ban ${isBanned ? 'is-banned' : ''}" onclick="openBanModal('${id}')"><i class="fas fa-lock"></i></button>
                            <button class="action-btn delete" onclick="deleteUser('${id}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                }
            }
            document.getElementById('statUsers').innerText = uCount; document.getElementById('statRevenue').innerText = formatMoney(totalM);
        });

        function openMoneyModal(id) { document.getElementById('uId').value = id; document.getElementById('uNameDisplay').innerText = id.replace(/_/g, '.'); document.getElementById('uNewBalance').value = currentUsers[id].balance || 0; document.getElementById('moneyModal').style.display = 'flex'; }
        function saveUserBalance() { let id = document.getElementById('uId').value, bal = Number(document.getElementById('uNewBalance').value); db.ref('users/'+id).update({balance: bal}).then(() => { showAdminToast("Cập nhật tiền xong"); db.ref('transactions').push().set({ user: id, type: 'admin_update', amount: bal, detail: 'Admin cập nhật số dư', time: new Date().toISOString() }); closeModal('moneyModal'); }); }
        function deleteUser(id) { if(confirm("XÓA TÀI KHOẢN?")) db.ref('users/'+id).remove(); }

        // 3. BAN SYSTEM
        function openBanModal(id) {
            document.getElementById('banUid').value = id; document.getElementById('banNameDisplay').innerText = id.replace(/_/g, '.'); let u = currentUsers[id];
            let now = new Date(); now.setHours(now.getHours() + 24); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('banUntil').value = now.toISOString().slice(0,16); document.getElementById('banReason').value = "";
            if(u.banned && new Date(u.ban_until).getTime() > new Date().getTime()) {
                document.getElementById('banStatusDisplay').style.display = 'block'; document.getElementById('btnUnbanBtn').style.display = 'block'; document.getElementById('banReason').value = u.ban_reason;
                let banD = new Date(u.ban_until); banD.setMinutes(banD.getMinutes() - banD.getTimezoneOffset()); document.getElementById('banUntil').value = banD.toISOString().slice(0,16);
            } else { document.getElementById('banStatusDisplay').style.display = 'none'; document.getElementById('btnUnbanBtn').style.display = 'none'; }
            document.getElementById('banModal').style.display = 'flex';
        }
        function executeBan() { let id = document.getElementById('banUid').value, reason = document.getElementById('banReason').value || "Vi phạm quy định", until = document.getElementById('banUntil').value; if(!until) return alert("Chọn ngày mở khóa!"); db.ref('users/'+id).update({ banned: true, ban_reason: reason, ban_until: new Date(until).toISOString() }).then(() => { showAdminToast("Đã Khóa User!", true); closeModal('banModal'); }); }
        function unbanUser() { let id = document.getElementById('banUid').value; db.ref('users/'+id).update({ banned: false, ban_reason: null, ban_until: null }).then(() => { showAdminToast("Đã ân xá."); closeModal('banModal'); }); }

        // 4. HISTORY
        db.ref('transactions').orderByChild('time').on('value', (s) => {
            let tbody = document.getElementById('historyTableBody'); tbody.innerHTML = '';
            if(s.exists()) {
                let transList = []; s.forEach(child => { transList.push(child.val()); }); transList.reverse();
                transList.forEach(t => {
                    let detailHtml = t.detail;
                    if(t.type === 'purchase' && t.key_granted) detailHtml = `${t.detail}<br><span style="font-size:11px; color:#f1c40f; font-family:monospace;">KEY: ${t.key_granted}</span>`;
                    tbody.innerHTML += `<tr><td style="font-size:12px; color:#888;">${new Date(t.time).toLocaleString('vi-VN')}</td><td style="font-weight:bold;">${t.user.replace(/_/g, '.')}</td><td><span style="background:rgba(255,255,255,0.1); padding:3px 8px; border-radius:5px; font-size:11px;">${t.type === 'purchase' ? 'Mua Sản Phẩm' : 'Cập Nhật'}</span></td><td style="color:${t.type === 'purchase' ? '#ff4757' : 'var(--accent)'}; font-weight:bold; font-family:monospace;">${t.type === 'purchase' ? '-' : '+'}${formatMoney(t.amount)}</td><td style="font-size:12px;">${detailHtml}</td></tr>`;
                });
            } else { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Chưa có giao dịch.</td></tr>`; }
        });
    </script>

