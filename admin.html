<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADMIN PANEL | QUOCDAT SEC</title>
    
    <script>
        var isAdminLoggedIn = sessionStorage.getItem('admin_auth_status');
        if (isAdminLoggedIn !== 'success') {
            var password = prompt("‚õî H·ªÜ TH·ªêNG B·∫¢O M·∫¨T C·∫§P CAO\n\nVui l√≤ng nh·∫≠p m·∫≠t kh·∫©u Qu·∫£n Tr·ªã Vi√™n:");
            if (password === "ngdaiquocdat") {
                sessionStorage.setItem('admin_auth_status', 'success');
                alert("‚úÖ X√°c th·ª±c th√†nh c√¥ng! Ch√†o m·ª´ng Admin.");
            } else {
                alert("‚ùå M·∫≠t kh·∫©u sai! Truy c·∫≠p b·ªã t·ª´ ch·ªëi.");
                window.location.replace("index.html");
            }
        }
        var currentUser = localStorage.getItem('vip_username') || 'admin_system';
        var safeUserId = currentUser.replace(/[.#$\[\]]/g, '_');

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function switchTab(tabId, el) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            let titles = {'dashboard':'T·ªîNG QUAN H·ªÜ TH·ªêNG', 'products':'QU·∫¢N L√ù S·∫¢N PH·∫®M', 'users':'QU·∫¢N L√ù NG∆Ø·ªúI D√ôNG', 'history':'QU·∫¢N L√ù KEY & L·ªäCH S·ª¨'};
            document.getElementById('pageTitle').innerText = titles[tabId];
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function logoutAdmin() { sessionStorage.removeItem('admin_auth_status'); window.location.replace('index.html'); }
        function showAdminToast(msg, isError = false) {
            let t = document.getElementById('toastMsg');
            t.style.borderLeftColor = isError ? '#ff4757' : '#00ff88';
            t.innerHTML = `<i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'}"></i> ${msg}`;
            t.classList.add('show');
            setTimeout(() => { t.classList.remove('show'); }, 3000);
        }
        function formatMoney(num) { return Number(num).toLocaleString('vi-VN') + " ƒë"; }
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #ff4757; --bg: #050508; --card-bg: #111; --border: #222; --accent: #00ff88; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; display: flex; height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #000; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        .sidebar { width: 260px; background: #0a0a0f; border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; z-index: 1000; }
        .brand { padding: 20px; font-family: 'Orbitron'; font-size: 20px; font-weight: 900; color: #fff; text-align: center; border-bottom: 1px solid var(--border); }
        .brand span { color: var(--primary); }
        .nav-menu { padding: 15px; flex: 1; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; color: #aaa; text-decoration: none; border-radius: 10px; margin-bottom: 5px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .nav-item.active { background: rgba(255,71,87,0.1); color: var(--primary); }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .topbar { height: 70px; background: rgba(10,10,15,0.9); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .content-area { padding: 20px; overflow-y: auto; flex: 1; }
        .tab-pane { display: none; } .tab-pane.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 15px; border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 20px; }
        
        .table-container { background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border); overflow-x: auto; margin-bottom: 20px; }
        .table-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .btn-add { background: var(--primary); color: #fff; padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #1a1a24; padding: 15px; text-align: left; font-size: 12px; color: #888; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        .action-btn { background: #222; border: 1px solid #333; color: #fff; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; margin-right: 5px; transition: 0.2s; }
        .action-btn.edit:hover { background: #1e90ff; border-color: #1e90ff; }
        .action-btn.money:hover { background: var(--accent); border-color: var(--accent); color: #000; }
        .action-btn.ban:hover { background: #f1c40f; border-color: #f1c40f; color: #000; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 90%; max-width: 500px; background: #15151e; border-radius: 15px; border: 1px solid #333; overflow: hidden; }
        .modal-head { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #111; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto;}
        .form-group { margin-bottom: 15px; } 
        .form-group label { display: block; font-size: 12px; color: #aaa; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; background: #0a0a0f; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; outline: none; }
        .modal-footer { padding: 20px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 10px; background: #111; }
        
        .toast { position: fixed; bottom: 20px; right: -300px; background: #111; border-left: 4px solid var(--primary); color: #fff; padding: 15px 25px; border-radius: 8px; font-size: 13px; font-weight: bold; transition: 0.4s; z-index: 10000; }
        .toast.show { right: 20px; }
        .mobile-toggle { display: none; } 
        @media (max-width: 768px) { .sidebar { position: fixed; left: -260px; height: 100vh; } .sidebar.open { left: 0; } .mobile-toggle { display: block; } }
    </style>
</head>
<body>
        <div class="sidebar" id="sidebar">
        <div class="brand" style="display:flex; justify-content:space-between; align-items:center;">
            <div>QUOCDAT<span style="color:var(--primary)">.ADMIN</span></div>
            <i class="fas fa-times mobile-toggle" onclick="toggleSidebar()"></i>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-chart-pie"></i> T·ªïng Quan</div>
            <div class="nav-item" onclick="switchTab('products', this)"><i class="fas fa-box-open"></i> Qu·∫£n L√Ω S·∫£n Ph·∫©m</div>
            <div class="nav-item" onclick="switchTab('users', this)"><i class="fas fa-users"></i> Qu·∫£n L√Ω User & Kh√≥a</div>
            <div class="nav-item" onclick="switchTab('history', this)"><i class="fas fa-key"></i> Qu·∫£n L√Ω KEY & L·ªãch S·ª≠</div>
            
            <a href="download.html" target="_blank" class="nav-item" style="border-top:1px dashed #333; margin-top:15px; color:#1e90ff;"><i class="fas fa-external-link-alt"></i> M·ªü C·ªïng Tr√≠ch Xu·∫•t</a>
            <div class="nav-item" style="color:#ff4757; margin-top:10px;" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</div>
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            <div style="display:flex; align-items:center; gap:15px;">
                <i class="fas fa-bars mobile-toggle" onclick="toggleSidebar()"></i>
                <div class="page-title" id="pageTitle">T·ªîNG QUAN H·ªÜ TH·ªêNG</div>
            </div>
            <a href="index.html" style="color:#fff; text-decoration:none; font-size:12px; border:1px solid #333; padding:8px 15px; border-radius:8px; background:#111;">V·ªÅ Trang Ch·ªß</a>
        </div>

        <div class="content-area">
            
            <div id="tab-dashboard" class="tab-pane active">
                <div class="stat-grid">
                    <div class="stat-card"><div class="stat-icon" style="background:rgba(0,255,136,0.1); color:var(--accent);"><i class="fas fa-wallet"></i></div><div><div style="font-size:11px; color:#888;">T·ªîNG N·∫†P</div><div id="statRevenue" style="font-size:20px; font-weight:bold; font-family:'Orbitron';">0 ƒë</div></div></div>
                    <div class="stat-card"><div class="stat-icon" style="background:rgba(30,144,255,0.1); color:#1e90ff;"><i class="fas fa-users"></i></div><div><div style="font-size:11px; color:#888;">USER ƒêƒÇNG K√ù</div><div id="statUsers" style="font-size:20px; font-weight:bold; font-family:'Orbitron';">0</div></div></div>
                    <div class="stat-card"><div class="stat-icon" style="background:rgba(255,71,87,0.1); color:var(--primary);"><i class="fas fa-box"></i></div><div><div style="font-size:11px; color:#888;">S·∫¢N PH·∫®M</div><div id="statProducts" style="font-size:20px; font-weight:bold; font-family:'Orbitron';">0</div></div></div>
                </div>
            </div>

            <div id="tab-products" class="tab-pane">
                <div class="table-container">
                    <div class="table-header"><h3>Kho S·∫£n Ph·∫©m C·ªßa B·∫°n</h3><button class="btn-add" onclick="openProductModal()"><i class="fas fa-plus"></i> Th√™m M·ªõi</button></div>
                    <table><thead><tr><th width="60">ID</th><th>T√™n S·∫£n Ph·∫©m</th><th>Gi√° B√°n</th><th width="100">Thao T√°c</th></tr></thead><tbody id="productTableBody"><tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i...</td></tr></tbody></table>
                </div>
            </div>

            <div id="tab-users" class="tab-pane">
                <div class="table-container">
                    <div class="table-header"><h3>Danh S√°ch Ng∆∞·ªùi D√πng</h3></div>
                    <table><thead><tr><th>T√†i Kho·∫£n</th><th>S·ªë D∆∞</th><th>Tr·∫°ng Th√°i</th><th width="120">Thao T√°c</th></tr></thead><tbody id="userTableBody"><tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i...</td></tr></tbody></table>
                </div>
            </div>

            <div id="tab-history" class="tab-pane">
                <div class="table-container">
                    <div class="table-header"><h3>Theo D√µi M√£ KEY ƒê√£ C·∫•p Ph√°t</h3></div>
                    <table>
                        <thead><tr><th>Th·ªùi Gian</th><th>T√†i Kho·∫£n</th><th>T√™n S·∫£n Ph·∫©m (Gi√°)</th><th>M√£ KEY</th><th>Link S·∫Ω Nh·∫£ Khi Tr√≠ch Xu·∫•t</th></tr></thead>
                        <tbody id="historyTableBody"><tr><td colspan="5" style="text-align:center;">ƒêang t·∫£i l·ªãch s·ª≠...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="productModal">
        <div class="modal-box">
            <div class="modal-head"><div class="modal-title" id="pModalTitle" style="color:var(--primary)">TH√äM S·∫¢N PH·∫®M</div><button style="background:none; border:none; color:#fff;" onclick="closeModal('productModal')"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <input type="hidden" id="pId">
                <div class="form-group"><label>T√™n S·∫£n Ph·∫©m *</label><input type="text" id="pName"></div>
                <div class="form-group"><label>Danh M·ª•c</label><select id="pCategory"><option value="Tool Social">Tool Social</option><option value="Script Game">Script Game</option><option value="Web Source">M√£ Ngu·ªìn Web</option></select></div>
                <div class="form-group"><label>Gi√° B√°n (VNƒê) - Nh·∫≠p 0 n·∫øu l√† ƒê·ªì Mi·ªÖn Ph√≠ *</label><input type="number" id="pPrice" placeholder="V√≠ d·ª•: 0 ho·∫∑c 150000"></div>
                <div class="form-group"><label>Link T·∫£i S·∫£n Ph·∫©m (Mediafire/Drive) *</label><input type="text" id="pDownload" placeholder="Nh·∫≠p Link ƒë·ªÉ kh√°ch t·∫£i sau khi mua..."></div>
                <div class="form-group"><label>M√¥ T·∫£ Ng·∫Øn</label><textarea id="pDesc" rows="2"></textarea></div>
                <div class="form-group"><label>Icon (FontAwesome)</label><input type="text" id="pImg" value="fas fa-box"></div>
            </div>
            <div class="modal-footer"><button style="padding:10px 20px; border-radius:8px; border:none; background:#333; color:#fff;" onclick="closeModal('productModal')">H·ªßy</button><button style="padding:10px 20px; border-radius:8px; border:none; background:var(--primary); font-weight:bold;" onclick="saveProduct()">L∆ØU</button></div>
        </div>
    </div>

    <div class="modal-overlay" id="moneyModal">
        <div class="modal-box"><div class="modal-head"><div class="modal-title" style="color:var(--accent);">C·∫¨P NH·∫¨T S·ªê D∆Ø</div><button style="background:none; border:none; color:#fff;" onclick="closeModal('moneyModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><input type="hidden" id="uId"><div style="margin-bottom:15px; color:#fff;">T√†i kho·∫£n: <strong id="uNameDisplay"></strong></div><div class="form-group"><label>Nh·∫≠p s·ªë d∆∞ m·ªõi (VNƒê) *</label><input type="number" id="uNewBalance"></div></div><div class="modal-footer"><button style="padding:10px 20px; border-radius:8px; border:none; background:#333; color:#fff;" onclick="closeModal('moneyModal')">H·ªßy</button><button style="padding:10px 20px; border-radius:8px; border:none; background:var(--accent); font-weight:bold;" onclick="saveUserBalance()">C·∫¨P NH·∫¨T</button></div></div>
    </div>

    <div class="modal-overlay" id="banModal">
        <div class="modal-box" style="border-color:#ff9f43;"><div class="modal-head" style="background:#2d1b00;"><div class="modal-title" style="color:#ff9f43;"><i class="fas fa-lock"></i> KH√ìA T√ÄI KHO·∫¢N</div><button style="background:none; border:none; color:#fff;" onclick="closeModal('banModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><input type="hidden" id="banUid"><div style="margin-bottom:15px; color:#fff;">Kh√≥a user: <strong id="banNameDisplay" style="color:#ff9f43;"></strong></div><div class="form-group"><label>L√Ω do kh√≥a *</label><input type="text" id="banReason" placeholder="VD: S·ª≠ d·ª•ng Bug..."></div><div class="form-group"><label>Kh√≥a ƒë·∫øn ng√†y gi·ªù *</label><input type="datetime-local" id="banUntil"></div><div id="banStatusDisplay" style="margin-top:10px; font-size:12px; color:#ff4757; font-weight:bold; display:none;">T√†i kho·∫£n n√†y ƒëang b·ªã kh√≥a!</div></div><div class="modal-footer"><button id="btnUnbanBtn" style="padding:10px 20px; border-radius:8px; border:none; background:#222; color:var(--accent); font-weight:bold; display:none;" onclick="unbanUser()">M·ªû KH√ìA</button><button style="padding:10px 20px; border-radius:8px; border:none; background:#ff9f43; font-weight:bold;" onclick="executeBan()">TH·ª∞C THI KH√ìA</button></div></div>
    </div>

    <div class="toast" id="toastMsg">Th√†nh c√¥ng!</div>
        <script>
        const firebaseConfig = { apiKey: "AIzaSyAWaCeduRtSP74OkRYJ6wvw8LPPkoLGsGc", databaseURL: "https://quocdat-b80c2-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "quocdat-b80c2" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentProducts = {};
        db.ref('products').on('value', (s) => {
            let tbody = document.getElementById('productTableBody'); tbody.innerHTML = ''; let pCount = 0;
            if(s.exists()) {
                currentProducts = s.val();
                for(let id in currentProducts) {
                    let p = currentProducts[id]; pCount++;
                    let priceText = p.price > 0 ? formatMoney(p.price) : '<span style="color:var(--primary);">MI·ªÑN PH√ç</span>';
                    tbody.innerHTML += `<tr><td><strong style="color:var(--primary)">#${id.substring(0,4)}</strong></td><td style="font-weight:bold;">${p.name}</td><td style="color:var(--accent); font-weight:bold; font-family:monospace;">${priceText}</td><td><button class="action-btn edit" onclick="openProductModal('${id}')"><i class="fas fa-edit"></i></button><button class="action-btn delete" onclick="deleteProduct('${id}')"><i class="fas fa-trash"></i></button></td></tr>`;
                }
            } else { tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Tr·ªëng</td></tr>`; }
            document.getElementById('statProducts').innerText = pCount;
        });

        function openProductModal(id = null) {
            document.getElementById('pId').value = ''; document.getElementById('pName').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('pDesc').value = ''; document.getElementById('pDownload').value = '';
            if(id) { let p = currentProducts[id]; document.getElementById('pId').value = id; document.getElementById('pName').value = p.name; document.getElementById('pPrice').value = p.price; document.getElementById('pCategory').value = p.category; document.getElementById('pDesc').value = p.desc || ''; document.getElementById('pImg').value = p.img || 'fas fa-box'; document.getElementById('pDownload').value = p.download_link || ''; }
            document.getElementById('productModal').style.display = 'flex';
        }

        function saveProduct() {
            let id = document.getElementById('pId').value; let priceVal = document.getElementById('pPrice').value; let rawLink = document.getElementById('pDownload').value.trim();
            if(rawLink !== "" && !rawLink.startsWith('http://') && !rawLink.startsWith('https://')) { rawLink = 'https://' + rawLink; }
            let data = { name: document.getElementById('pName').value, price: priceVal !== "" ? Number(priceVal) : "", category: document.getElementById('pCategory').value, desc: document.getElementById('pDesc').value, img: document.getElementById('pImg').value, download_link: rawLink };
            if(!data.name || data.price === "" || data.price === null || !data.download_link) return alert("ƒêi·ªÅn ƒë·ªß T√™n, Gi√° (nh·∫≠p 0 n·∫øu Free) v√† Link t·∫£i!");
            if(id) db.ref('products/' + id).update(data).then(() => { showAdminToast("C·∫≠p nh·∫≠t SP xong"); closeModal('productModal'); });
            else db.ref('products').push().set(data).then(() => { showAdminToast("ƒê√£ th√™m SP"); closeModal('productModal'); });
        }
        function deleteProduct(id) { if(confirm("X√≥a s·∫£n ph·∫©m n√†y?")) db.ref('products/'+id).remove(); }

        let currentUsers = {};
        db.ref('users').on('value', (s) => {
            let tbody = document.getElementById('userTableBody'); tbody.innerHTML = ''; let uCount = 0, totalM = 0;
            if(s.exists()) {
                currentUsers = s.val();
                for(let id in currentUsers) {
                    let u = currentUsers[id]; uCount++; totalM += (u.balance || 0);
                    let isBanned = u.banned && new Date(u.ban_until).getTime() > new Date().getTime();
                    let statusHtml = isBanned ? `<span style="color:#ff4757; font-size:11px; font-weight:bold;"><i class="fas fa-lock"></i> ƒê√£ Kh√≥a</span>` : `<span style="color:var(--accent); font-size:11px;"><i class="fas fa-check"></i> An To√†n</span>`;
                    tbody.innerHTML += `<tr><td style="font-weight:bold;">${id.replace(/_/g, '.')}</td><td style="color:var(--accent); font-family:monospace; font-weight:bold;">${formatMoney(u.balance || 0)}</td><td>${statusHtml}</td><td><button class="action-btn money" onclick="openMoneyModal('${id}')"><i class="fas fa-coins"></i></button><button class="action-btn ban ${isBanned ? 'is-banned' : ''}" onclick="openBanModal('${id}')"><i class="fas fa-lock"></i></button><button class="action-btn delete" onclick="deleteUser('${id}')"><i class="fas fa-trash"></i></button></td></tr>`;
                }
            }
            document.getElementById('statUsers').innerText = uCount; document.getElementById('statRevenue').innerText = formatMoney(totalM);
        });

        function openMoneyModal(id) { document.getElementById('uId').value = id; document.getElementById('uNameDisplay').innerText = id.replace(/_/g, '.'); document.getElementById('uNewBalance').value = currentUsers[id].balance || 0; document.getElementById('moneyModal').style.display = 'flex'; }
        function saveUserBalance() { let id = document.getElementById('uId').value, bal = Number(document.getElementById('uNewBalance').value); db.ref('users/'+id).update({balance: bal}).then(() => { showAdminToast("C·∫≠p nh·∫≠t ti·ªÅn xong"); db.ref('transactions').push().set({ user: id, type: 'admin_update', amount: bal, detail: 'Admin c·∫≠p nh·∫≠t s·ªë d∆∞', time: new Date().toISOString() }); closeModal('moneyModal'); }); }
        function deleteUser(id) { if(confirm("X√ìA T√ÄI KHO·∫¢N?")) db.ref('users/'+id).remove(); }
        function openBanModal(id) { /* Gi·ªØ nguy√™n h√†m ban c≈© */ document.getElementById('banUid').value = id; document.getElementById('banNameDisplay').innerText = id.replace(/_/g, '.'); let u = currentUsers[id]; let now = new Date(); now.setHours(now.getHours() + 24); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); document.getElementById('banUntil').value = now.toISOString().slice(0,16); document.getElementById('banReason').value = ""; if(u.banned && new Date(u.ban_until).getTime() > new Date().getTime()) { document.getElementById('banStatusDisplay').style.display = 'block'; document.getElementById('btnUnbanBtn').style.display = 'block'; document.getElementById('banReason').value = u.ban_reason; let banD = new Date(u.ban_until); banD.setMinutes(banD.getMinutes() - banD.getTimezoneOffset()); document.getElementById('banUntil').value = banD.toISOString().slice(0,16); } else { document.getElementById('banStatusDisplay').style.display = 'none'; document.getElementById('btnUnbanBtn').style.display = 'none'; } document.getElementById('banModal').style.display = 'flex'; }
        function executeBan() { let id = document.getElementById('banUid').value, reason = document.getElementById('banReason').value || "Vi ph·∫°m quy ƒë·ªãnh", until = document.getElementById('banUntil').value; if(!until) return alert("Ch·ªçn ng√†y m·ªü kh√≥a!"); db.ref('users/'+id).update({ banned: true, ban_reason: reason, ban_until: new Date(until).toISOString() }).then(() => { showAdminToast("ƒê√£ Kh√≥a User!", true); closeModal('banModal'); }); }
        function unbanUser() { let id = document.getElementById('banUid').value; db.ref('users/'+id).update({ banned: false, ban_reason: null, ban_until: null }).then(() => { showAdminToast("ƒê√£ √¢n x√°."); closeModal('banModal'); }); }

        // 4. B·∫¢NG THEO D√ïI KEY & LINK ƒê√çCH (M·ªöI N√ÇNG C·∫§P)
        db.ref('transactions').orderByChild('time').on('value', (s) => {
            let tbody = document.getElementById('historyTableBody'); tbody.innerHTML = '';
            if(s.exists()) {
                let transList = []; s.forEach(child => { transList.push(child.val()); }); transList.reverse();
                transList.forEach(t => {
                    let time = new Date(t.time).toLocaleString('vi-VN');
                    let uName = t.user.replace(/_/g, '.');
                    
                    // N·∫øu l√† Mua H√†ng / Nh·∫≠n Mi·ªÖn Ph√≠ (c√≥ KEY)
                    if(t.type === 'purchase') {
                        let keyText = t.key_granted ? `<span style="color:#f1c40f; font-family:monospace; font-weight:bold; background:#222; padding:3px 8px; border-radius:5px;">${t.key_granted}</span>` : '-';
                        let linkHtml = t.download_link && t.download_link !== '#' ? `<a href="${t.download_link}" target="_blank" style="color:#1e90ff; font-size:12px;"><i class="fas fa-link"></i> Xem Link ƒê√≠ch</a>` : `<span style="color:#ff4757; font-size:12px;">Ch∆∞a g·∫Øn link</span>`;
                        let priceTag = t.amount > 0 ? `<span style="color:#ff4757;">(${formatMoney(t.amount)})</span>` : `<span style="color:var(--primary);">(Mi·ªÖn Ph√≠)</span>`;

                        tbody.innerHTML += `<tr>
                            <td style="font-size:12px; color:#888;">${time}</td>
                            <td style="font-weight:bold;">${uName}</td>
                            <td style="font-size:13px;">${t.detail.replace('Mua: ', '').replace('Nh·∫≠n Mi·ªÖn Ph√≠: ', '')} <br>${priceTag}</td>
                            <td>${keyText}</td>
                            <td>${linkHtml}</td>
                        </tr>`;
                    } else {
                        // Giao d·ªãch n·∫°p ti·ªÅn th√¥ng th∆∞·ªùng
                        tbody.innerHTML += `<tr>
                            <td style="font-size:12px; color:#888;">${time}</td>
                            <td style="font-weight:bold;">${uName}</td>
                            <td style="font-size:13px; color:#aaa;">N·∫°p Ti·ªÅn / C·∫≠p Nh·∫≠t</td>
                            <td style="color:var(--accent); font-weight:bold; font-family:monospace;">+${formatMoney(t.amount)}</td>
                            <td>-</td>
                        </tr>`;
                    }
                });
            } else { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu KEY n√†o.</td></tr>`; }
        });
    </script>
</body>
</html>
    <script>
        // 1. T·ª± ƒë·ªông c·∫•y giao di·ªán Editor N√¢ng cao v√†o d∆∞·ªõi c√πng c·ªßa Admin Panel
        const editorHTML = `
        <div class="card" style="border-color: #ff4757; margin-top: 30px;">
            <h3 class="card-title" style="color: #ff4757;"><i class="fas fa-code"></i> TR√åNH SO·∫†N TH·∫¢O M√É NGU·ªíN G·ªêC (RAW HTML)</h3>
            <p style="color:#888; font-size:13px; margin-bottom:15px;">Ghi ƒë√® ho√†n to√†n giao di·ªán c·ªßa c√°c trang b·∫±ng m√£ HTML/CSS/JS m·ªõi th√¥ng qua Firebase.</p>
            
            <div class="form-group">
                <label>Ch·ªçn trang ƒë·ªÉ can thi·ªáp:</label>
                <select id="pageSelect" onchange="loadRawCode()" style="margin-bottom: 15px;">
                    <option value="getkey_html">Trang getkey.html</option>
                    <option value="key_html">Trang key.html</option>
                    <option value="index_html">Trang index.html</option>
                </select>
            </div>

            <div class="form-group">
                <textarea id="rawCodeArea" rows="15" placeholder="Nh·∫≠p m√£ HTML m·ªõi c·ªßa b·∫°n v√†o ƒë√¢y. ƒê·ªÉ tr·ªëng n·∫øu mu·ªën d√πng giao di·ªán m·∫∑c ƒë·ªãnh..." style="width: 100%; background: #000; color: #00ff88; border: 1px solid #2a2a35; padding: 15px; border-radius: 8px; font-family: monospace; outline: none; resize: vertical; line-height: 1.5;"></textarea>
            </div>
            
            <button class="btn" style="background: #ff4757; color: white; width: 100%;" onclick="saveRawCode()"><i class="fas fa-cloud-upload-alt"></i> √âP L∆ØU M√É NGU·ªíN L√äN M√ÅY CH·ª¶</button>
        </div>
        `;
        
        // Ch√®n giao di·ªán v√†o cu·ªëi Admin Panel
        document.getElementById('adminPanel').insertAdjacentHTML('beforeend', editorHTML);

        // 2. H√†m k√©o code t·ª´ Firebase v·ªÅ khung so·∫°n th·∫£o
        function loadRawCode() {
            let page = document.getElementById('pageSelect').value;
            db.ref('raw_code/' + page).once('value', snap => {
                document.getElementById('rawCodeArea').value = snap.val() || "";
            });
        }

        // 3. H√†m ƒë·∫©y code m·ªõi l√™n Firebase
        function saveRawCode() {
            let page = document.getElementById('pageSelect').value;
            let code = document.getElementById('rawCodeArea').value;
            
            if(confirm("C·∫¢NH B√ÅO T·ªêI CAO: M√£ n√†y s·∫Ω ghi ƒë√® l√™n to√†n b·ªô trang " + page + ". B·∫°n c√≥ ch·∫Øc ch·∫Øn code kh√¥ng b·ªã l·ªói ch·ª©?")) {
                db.ref('raw_code/' + page).set(code).then(() => {
                    alert("Th√†nh c√¥ng! L·∫ßn t·ªõi kh√°ch v√†o trang web s·∫Ω t·∫£i ƒëo·∫°n m√£ m·ªõi n√†y.");
                }).catch(err => alert("L·ªói l∆∞u tr·ªØ: " + err.message));
            }
        }
        
        // 4. M√≥c n·ªëi ƒë·ªÉ t·ª± ƒë·ªông ch·∫°y khi admin ƒëƒÉng nh·∫≠p th√†nh c√¥ng
        const oldLoadData = typeof loadData === 'function' ? loadData : function(){};
        loadData = function() {
            oldLoadData(); // Ch·∫°y c√°c ch·ª©c nƒÉng c≈©
            loadRawCode(); // Ch·∫°y th√™m ch·ª©c nƒÉng t·∫£i code
        };
    </script>
    ```

---

### üü° B∆∞·ªõc 2: S·ª± th·∫≠t b·∫°n c·∫ßn l√†m ƒë·ªÉ n√≥ ho·∫°t ƒë·ªông (C·ª±c k·ª≥ quan tr·ªçng)

Nh∆∞ t√¥i ƒë√£ n√≥i ·ªü tr√™n, `admin.html` ƒë·∫©y code l√™n Firebase l√† m·ªôt chuy·ªán, nh∆∞ng `getkey.html` hay `index.html` **ch∆∞a bi·∫øt** ƒë·ªÉ m√† k√©o ƒëo·∫°n code ƒë√≥ v·ªÅ x√†i. 

B·∫°n b·∫Øt bu·ªôc ph·∫£i m·ªü file `getkey.html` v√† `key.html` ra, d√°n **ƒëo·∫°n m√£ ƒÉng-ten** n√†y v√†o ngay d∆∞·ªõi ch·ªØ `<head>`. N√≥ s·∫Ω gi√∫p trang web ph√°t hi·ªán xem Admin c√≥ ƒëang b·∫Øt n√≥ ƒë·ªïi giao di·ªán kh√¥ng. N·∫øu c√≥, n√≥ t·ª± x√≥a s·∫°ch b·∫£n th√¢n v√† hi·ªÉn th·ªã code m·ªõi c·ªßa b·∫°n.

**D√°n ƒëo·∫°n n√†y v√†o th·∫ª `<head>` c·ªßa c√°c file `getkey.html` v√† `key.html`:**

```html
    <script>
        // X√°c ƒë·ªãnh trang hi·ªán t·∫°i ƒëang ch·∫°y (getkey_html, key_html...)
        const currentPage = window.location.pathname.split('/').pop().replace('.html', '_html') || 'index_html';
        
        // Firebase Config b·∫Øt bu·ªôc ph·∫£i c√≥ ·ªü ƒë√¢y ƒë·ªÉ qu√©t tr∆∞·ªõc khi trang k·ªãp load
        const fbConfig = { apiKey: "AIzaSyAWaCeduRtSP74OkRYJ6wvw8LPPkoLGsGc", databaseURL: "https://quocdat-b80c2-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "quocdat-b80c2" };
        if (!firebase.apps.length) firebase.initializeApp(fbConfig);
        
        // K√©o m√£ ngu·ªìn th√¥ (n·∫øu c√≥) t·ª´ Admin v·ªÅ v√† √©p ghi ƒë√®
        firebase.database().ref('raw_code/' + currentPage).once('value', snap => {
            let customCode = snap.val();
            // N·∫øu admin c√≥ ƒëi·ªÅn code v√†o khung, x√≥a s·∫°ch trang c≈© v√† n·∫°p code m·ªõi
            if (customCode && customCode.trim() !== "") {
                document.open();
                document.write(customCode);
                document.close();
            }
        });
    </script>
    

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
