<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADMIN PANEL | QUOCDAT SEC</title>
    
    <script>
        // Kiểm tra xem trong phiên làm việc này Admin đã nhập pass chưa
        var isAdminLoggedIn = sessionStorage.getItem('admin_auth_status');
        
        if (isAdminLoggedIn !== 'success') {
            // Hiển thị hộp thoại nhập mật khẩu
            var password = prompt("⛔ HỆ THỐNG BẢO MẬT CẤP CAO\n\nVui lòng nhập mật khẩu Quản Trị Viên:");
            
            if (password === "ngdaiquocdat") {
                // Nhập đúng -> Lưu trạng thái để khi F5 không bị hỏi lại
                sessionStorage.setItem('admin_auth_status', 'success');
                alert("✅ Xác thực thành công! Chào mừng Admin.");
            } else {
                // Nhập sai -> Đá về trang chủ
                alert("❌ Mật khẩu sai! Truy cập bị từ chối.");
                window.location.replace("index.html");
            }
        }

        // Tạo sẵn biến giả lập để Firebase không bị lỗi khi Admin thao tác
        var currentUser = localStorage.getItem('vip_username') || 'admin_system';
        var safeUserId = currentUser.replace(/[.#$\[\]]/g, '_');
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #ff4757; --bg: #050508; --card-bg: #111; --border: #222; --accent: #00ff88; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; display: flex; height: 100vh; overflow: hidden; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        /* SIDEBAR ADMIN */
        .sidebar { width: 260px; background: #0a0a0f; border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; z-index: 1000; }
        .brand { padding: 20px; font-family: 'Orbitron'; font-size: 20px; font-weight: 900; color: #fff; text-align: center; border-bottom: 1px solid var(--border); letter-spacing: 1px; }
        .brand span { color: var(--primary); }
        .admin-profile { padding: 20px; text-align: center; border-bottom: 1px solid var(--border); }
        .admin-ava { width: 60px; height: 60px; background: var(--primary); border-radius: 50%; margin: 0 auto 10px; display: flex; justify-content: center; align-items: center; font-size: 24px; font-weight: bold; color: #fff; font-family: 'Orbitron'; }
        
        .nav-menu { padding: 15px; flex: 1; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; color: #aaa; text-decoration: none; border-radius: 10px; margin-bottom: 5px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: rgba(255,71,87,0.1); color: var(--primary); }
        .nav-item i { width: 20px; text-align: center; font-size: 18px; }

        /* MAIN CONTENT & TOPBAR */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .topbar { height: 70px; background: rgba(10,10,15,0.9); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; backdrop-filter: blur(10px); }
        .page-title { font-family: 'Orbitron'; font-size: 18px; font-weight: bold; text-transform: uppercase; }
        .btn-view-site { background: #222; color: #fff; padding: 8px 15px; border-radius: 8px; font-size: 12px; font-weight: bold; text-decoration: none; border: 1px solid #333; transition: 0.3s; }
        .btn-view-site:hover { background: var(--accent); color: #000; }
        
        /* CONTENT AREA & TABS */
        .content-area { padding: 20px; overflow-y: auto; flex: 1; }
        .tab-pane { display: none; animation: fadeIn 0.4s; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* DASHBOARD CARDS */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 25px; border-radius: 15px; border: 1px solid var(--border); display: flex; align-items: center; gap: 20px; }
        .stat-icon { width: 60px; height: 60px; border-radius: 15px; display: flex; justify-content: center; align-items: center; font-size: 24px; }
        .stat-info div { font-size: 12px; color: #888; text-transform: uppercase; font-weight: bold; margin-bottom: 5px; }
        .stat-info span { font-size: 24px; font-family: 'Orbitron'; font-weight: 900; color: #fff; }

        /* TABLES */
        .table-container { background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border); overflow-x: auto; margin-bottom: 20px; }
        .table-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .btn-add { background: var(--primary); color: #fff; padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.3s; }
        
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #1a1a24; padding: 15px; text-align: left; font-size: 12px; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
        tr:hover td { background: rgba(255,255,255,0.02); }
        
        /* ACTION BUTTONS */
        .action-btn { background: #222; border: 1px solid #333; color: #fff; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; margin-right: 5px; transition: 0.2s; }
        .action-btn.edit:hover { background: #1e90ff; border-color: #1e90ff; }
        .action-btn.delete:hover { background: var(--primary); border-color: var(--primary); }
        .action-btn.money:hover { background: var(--accent); border-color: var(--accent); color: #000; }

        /* FORMS & MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { width: 90%; max-width: 500px; background: #15151e; border-radius: 15px; border: 1px solid #333; overflow: hidden; }
        .modal-head { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #111; }
        .modal-title { font-weight: bold; font-family: 'Orbitron'; color: var(--primary); }
        .modal-close { background: transparent; border: none; color: #888; font-size: 20px; cursor: pointer; }
        .modal-body { padding: 20px; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; color: #aaa; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; background: #0a0a0f; border: 1px solid #333; color: #fff; padding: 12px 15px; border-radius: 8px; outline: none; font-size: 14px; }
        .form-group input:focus { border-color: var(--primary); }
        
        .modal-footer { padding: 20px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 10px; background: #111; }
        .btn-cancel { background: #333; color: #fff; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-save { background: var(--primary); color: #fff; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }

        /* TOAST */
        .toast { position: fixed; bottom: 20px; right: -300px; background: #111; border-left: 4px solid var(--primary); color: #fff; padding: 15px 25px; border-radius: 8px; font-size: 13px; font-weight: bold; transition: 0.4s; z-index: 10000; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .toast.show { right: 20px; }

        /* MOBILE MENU TOGGLE */
        .mobile-toggle { display: none; font-size: 24px; cursor: pointer; }
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100vh; }
            .sidebar.open { left: 0; }
            .mobile-toggle { display: block; }
            .brand { display: flex; justify-content: space-between; }
        }
    </style>
</head>
<body>
        <div class="sidebar" id="sidebar">
        <div class="brand">QUOCDAT<span>.ADMIN</span> <i class="fas fa-times mobile-toggle" style="font-size: 18px;" onclick="toggleSidebar()"></i></div>
        <div class="admin-profile">
            <div class="admin-ava">A</div>
            <div style="font-weight:bold; font-family:'Orbitron';">Super Admin</div>
            <div style="font-size:11px; color:var(--primary); margin-top:5px;"><i class="fas fa-shield-check"></i> Toàn Quyền Hệ Thống</div>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-chart-pie"></i> Tổng Quan</div>
            <div class="nav-item" onclick="switchTab('products', this)"><i class="fas fa-box-open"></i> Quản Lý Sản Phẩm</div>
            <div class="nav-item" onclick="switchTab('users', this)"><i class="fas fa-users"></i> Quản Lý User</div>
            <div class="nav-item" onclick="switchTab('settings', this)"><i class="fas fa-cogs"></i> Cài Đặt Hệ Thống</div>
            <div class="nav-item" style="color:#ff4757; margin-top:20px;" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i> Thoát Khỏi Admin</div>
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            <div style="display:flex; align-items:center; gap:15px;">
                <i class="fas fa-bars mobile-toggle" onclick="toggleSidebar()"></i>
                <div class="page-title" id="pageTitle">TỔNG QUAN HỆ THỐNG</div>
            </div>
            <div class="topbar-right">
                <a href="index.html" class="btn-view-site" target="_blank"><i class="fas fa-external-link-alt"></i> Trở về Trang Chủ</a>
            </div>
        </div>

        <div class="content-area">
            
            <div id="tab-dashboard" class="tab-pane active">
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background:rgba(0,255,136,0.1); color:var(--accent);"><i class="fas fa-wallet"></i></div>
                        <div class="stat-info"><div>Tổng Nạp User</div><span id="statRevenue">0 đ</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:rgba(30,144,255,0.1); color:#1e90ff;"><i class="fas fa-users"></i></div>
                        <div class="stat-info"><div>Tổng Thành Viên</div><span id="statUsers">0</span></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background:rgba(255,71,87,0.1); color:var(--primary);"><i class="fas fa-box"></i></div>
                        <div class="stat-info"><div>Sản Phẩm Đang Bán</div><span id="statProducts">0</span></div>
                    </div>
                </div>
                <div class="table-container">
                    <div class="table-header"><h3 style="font-size:16px;">Hoạt Động Gần Đây</h3></div>
                    <div style="padding:40px; text-align:center; color:#555; font-size:14px;">Chưa có dữ liệu hệ thống mới.</div>
                </div>
            </div>

            <div id="tab-products" class="tab-pane">
                <div class="table-container">
                    <div class="table-header">
                        <h3 style="font-size:16px;">Kho Sản Phẩm Của Bạn</h3>
                        <button class="btn-add" onclick="openProductModal()"><i class="fas fa-plus"></i> Thêm Sản Phẩm Mới</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th width="60">ID</th>
                                <th>Tên Sản Phẩm</th>
                                <th>Danh Mục</th>
                                <th>Giá Bán (VNĐ)</th>
                                <th width="120">Thao Tác</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                            <tr><td colspan="5" style="text-align:center; color:#555;">Đang tải dữ liệu từ máy chủ Firebase...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-users" class="tab-pane">
                <div class="table-container">
                    <div class="table-header">
                        <h3 style="font-size:16px;">Danh Sách Thành Viên (Người Dùng)</h3>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Tên Tài Khoản</th>
                                <th>Số Dư Ví Hiện Tại</th>
                                <th>Ngày Tạo</th>
                                <th width="120">Nạp/Trừ Tiền</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <tr><td colspan="4" style="text-align:center; color:#555;">Đang tải danh sách người dùng...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="tab-settings" class="tab-pane">
                <div class="table-container" style="padding:30px;">
                    <h3 style="color:var(--primary); margin-bottom:20px;"><i class="fas fa-cogs"></i> Tùy Chỉnh Nâng Cao</h3>
                    <p style="color:#888; font-size:14px; line-height: 1.6;">Chức năng Cài đặt Cổng gạch thẻ, Cấu hình API Link4M rút gọn và Thay đổi Pass Admin đang được DEV tiến hành vá ở phiên bản tiếp theo. Hiện tại vui lòng quản lý Sản phẩm và User.</p>
                </div>
            </div>

        </div>
    </div>

    <div class="modal-overlay" id="productModal">
        <div class="modal-box">
            <div class="modal-head">
                <div class="modal-title" id="pModalTitle">THÊM SẢN PHẨM MỚI</div>
                <button class="modal-close" onclick="closeModal('productModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="pId">
                <div class="form-group">
                    <label>Tên Sản Phẩm *</label>
                    <input type="text" id="pName" placeholder="VD: Tool Facebook Pro V9" required>
                </div>
                <div class="form-group">
                    <label>Danh Mục</label>
                    <select id="pCategory">
                        <option value="Tool Social">Tool Social</option>
                        <option value="Script Game">Script Game</option>
                        <option value="Web Source">Mã Nguồn Web</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Giá Bán (VNĐ) *</label>
                    <input type="number" id="pPrice" placeholder="VD: 250000" required>
                </div>
                <div class="form-group">
                    <label>Mô Tả Chức Năng</label>
                    <textarea id="pDesc" rows="3" placeholder="Ghi chú các tính năng nổi bật..."></textarea>
                </div>
                <div class="form-group">
                    <label>Mã Ảnh Icon (Dùng FontAwesome)</label>
                    <input type="text" id="pImg" placeholder="VD: fas fa-robot" value="fas fa-box">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('productModal')">Đóng</button>
                <button class="btn-save" onclick="saveProduct()">LƯU SẢN PHẨM</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="moneyModal">
        <div class="modal-box">
            <div class="modal-head">
                <div class="modal-title" style="color:var(--accent);">ĐIỀU CHỈNH SỐ DƯ TÀI KHOẢN</div>
                <button class="modal-close" onclick="closeModal('moneyModal')"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="uId">
                <div style="margin-bottom:20px; padding:15px; background:rgba(0,184,255,0.1); border:1px dashed var(--accent); border-radius:10px;">
                    <div style="font-size:12px; color:#888;">Thao tác với tài khoản:</div>
                    <strong id="uNameDisplay" style="font-size:18px; color:#fff; font-family:'Orbitron';">...</strong>
                </div>
                <div class="form-group">
                    <label>Nhập Số Dư Cần Ghi Đè (VNĐ) *</label>
                    <input type="number" id="uNewBalance" placeholder="Nhập tổng số tiền hiện tại của khách...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeModal('moneyModal')">Hủy Lệnh</button>
                <button class="btn-save" style="background:var(--accent); color:#000;" onclick="saveUserBalance()">CẬP NHẬT TIỀN</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toastMsg">Thành công!</div>
                            <script>
        // Bật / Tắt Menu trên điện thoại
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        // Chuyển Đổi Các Tab Chức Năng
        function switchTab(tabId, element) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            let titles = {
                'dashboard': 'TỔNG QUAN HỆ THỐNG',
                'products': 'QUẢN LÝ SẢN PHẨM SCRIPT',
                'users': 'QUẢN LÝ THÀNH VIÊN VÀ TIỀN BẠC',
                'settings': 'CÀI ĐẶT HỆ THỐNG'
            };
            document.getElementById('pageTitle').innerText = titles[tabId];
        }

        // Hàm Tắt Admin (Hủy session pass)
        function logoutAdmin() {
            sessionStorage.removeItem('admin_auth_status');
            window.location.replace('index.html');
        }

        // Cửa sổ thông báo góc dưới
        function showAdminToast(msg, isError = false) {
            let toast = document.getElementById('toastMsg');
            toast.style.borderLeftColor = isError ? '#ff4757' : '#00ff88';
            toast.innerHTML = `<i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'}"></i> ${msg}`;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        }

        function formatMoney(num) {
            return Number(num).toLocaleString('vi-VN') + " đ";
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // ===============================================
        // KẾT NỐI FIREBASE BẰNG API KEY CỦA BẠN
        // ===============================================
        const firebaseConfig = { 
            apiKey: "AIzaSyAWaCeduRtSP74OkRYJ6wvw8LPPkoLGsGc", 
            databaseURL: "https://quocdat-b80c2-default-rtdb.asia-southeast1.firebasedatabase.app", 
            projectId: "quocdat-b80c2" 
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // -----------------------------------------------
        // PHẦN 1: QUẢN LÝ SẢN PHẨM (THÊM / SỬA / XÓA)
        // -----------------------------------------------
        let currentProducts = {};

        function loadProducts() {
            db.ref('products').on('value', (snapshot) => {
                let tbody = document.getElementById('productTableBody');
                tbody.innerHTML = '';
                let count = 0;
                
                if(snapshot.exists()) {
                    currentProducts = snapshot.val();
                    for(let id in currentProducts) {
                        let p = currentProducts[id];
                        count++;
                        let tr = `
                            <tr>
                                <td><strong style="color:var(--primary)">#${id.substring(0,4)}</strong></td>
                                <td style="font-weight:bold;"><i class="${p.img || 'fas fa-box'}" style="margin-right:8px; color:#888;"></i> ${p.name}</td>
                                <td><span style="background:#222; padding:5px 10px; border-radius:5px; font-size:11px;">${p.category}</span></td>
                                <td style="color:var(--accent); font-family:monospace; font-weight:bold; font-size:16px;">${formatMoney(p.price)}</td>
                                <td>
                                    <button class="action-btn edit" onclick="openProductModal('${id}')" title="Sửa Sản Phẩm"><i class="fas fa-edit"></i></button>
                                    <button class="action-btn delete" onclick="deleteProduct('${id}')" title="Xóa Sản Phẩm"><i class="fas fa-trash-alt"></i></button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += tr;
                    }
                    document.getElementById('statProducts').innerText = count;
                } else {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#555;">Kho hàng đang trống. Bấm Thêm Sản Phẩm Mới để bắt đầu!</td></tr>`;
                    document.getElementById('statProducts').innerText = '0';
                }
            });
        }

        function openProductModal(id = null) {
            // Xóa rỗng form trước khi mở
            document.getElementById('pId').value = '';
            document.getElementById('pName').value = '';
            document.getElementById('pPrice').value = '';
            document.getElementById('pCategory').value = 'Tool Social';
            document.getElementById('pDesc').value = '';
            document.getElementById('pImg').value = 'fas fa-box';
            
            document.getElementById('pModalTitle').innerText = 'THÊM SẢN PHẨM MỚI';

            // Nếu là lệnh SỬA (Có ID truyền vào)
            if(id && currentProducts[id]) {
                let p = currentProducts[id];
                document.getElementById('pModalTitle').innerText = 'CHỈNH SỬA SẢN PHẨM';
                document.getElementById('pId').value = id;
                document.getElementById('pName').value = p.name;
                document.getElementById('pPrice').value = p.price;
                document.getElementById('pCategory').value = p.category;
                document.getElementById('pDesc').value = p.desc || '';
                document.getElementById('pImg').value = p.img || 'fas fa-box';
            }
            
            document.getElementById('productModal').style.display = 'flex';
        }

        function saveProduct() {
            let id = document.getElementById('pId').value;
            let name = document.getElementById('pName').value;
            let price = Number(document.getElementById('pPrice').value);
            let category = document.getElementById('pCategory').value;
            let desc = document.getElementById('pDesc').value;
            let img = document.getElementById('pImg').value;

            if(!name || !price) {
                alert("LỖI: Vui lòng điền tên và giá tiền của sản phẩm!"); return;
            }

            let productData = { name: name, price: price, category: category, desc: desc, img: img };

            if(id) {
                // UPDATE GHI ĐÈ LÊN SẢN PHẨM CŨ
                db.ref('products/' + id).update(productData).then(() => {
                    showAdminToast("Đã cập nhật sản phẩm thành công!");
                    closeModal('productModal');
                });
            } else {
                // TẠO MỚI SẢN PHẨM
                let newRef = db.ref('products').push();
                newRef.set(productData).then(() => {
                    showAdminToast("Đã thêm một sản phẩm mới vào Cửa Hàng!");
                    closeModal('productModal');
                });
            }
        }

        function deleteProduct(id) {
            if(confirm("⚠ CẢNH BÁO: Bạn có chắc chắn muốn XÓA VĨNH VIỄN sản phẩm này không?")) {
                db.ref('products/' + id).remove().then(() => {
                    showAdminToast("Đã xóa sản phẩm khỏi Database.");
                });
            }
        }

        // -----------------------------------------------
        // PHẦN 2: QUẢN LÝ NGƯỜI DÙNG (CỘNG TRỪ TIỀN)
        // -----------------------------------------------
        let currentUsers = {};

        function loadUsers() {
            db.ref('users').on('value', (snapshot) => {
                let tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';
                let count = 0;
                let totalMoney = 0;
                
                if(snapshot.exists()) {
                    currentUsers = snapshot.val();
                    for(let id in currentUsers) {
                        let u = currentUsers[id];
                        count++;
                        let bal = u.balance || 0;
                        totalMoney += bal;
                        
                        // Lấy lại tên gốc (Trường hợp có dấu chấm bị thay bằng _ )
                        let displayId = id.replace(/_/g, '.'); 
                        let date = u.joined_at ? new Date(u.joined_at).toLocaleDateString('vi-VN') : 'Không rõ';

                        let tr = `
                            <tr>
                                <td style="font-weight:bold; color:#fff;"><i class="fas fa-user-astronaut" style="color:#555; margin-right:8px;"></i> ${displayId}</td>
                                <td style="color:var(--primary); font-family:monospace; font-size:16px; font-weight:bold;">${formatMoney(bal)}</td>
                                <td style="color:#888; font-size:12px;">${date}</td>
                                <td>
                                    <button class="action-btn money" onclick="openMoneyModal('${id}')" title="Cộng / Trừ Tiền"><i class="fas fa-coins"></i></button>
                                    <button class="action-btn delete" onclick="deleteUser('${id}')" title="Xóa Người Dùng"><i class="fas fa-user-slash"></i></button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += tr;
                    }
                    document.getElementById('statUsers').innerText = count;
                    document.getElementById('statRevenue').innerText = formatMoney(totalMoney);
                } else {
                    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:#555;">Hệ thống chưa có người dùng nào đăng ký.</td></tr>`;
                    document.getElementById('statUsers').innerText = '0';
                    document.getElementById('statRevenue').innerText = '0 đ';
                }
            });
        }

        function openMoneyModal(userId) {
            let u = currentUsers[userId];
            document.getElementById('uId').value = userId;
            document.getElementById('uNameDisplay').innerText = userId.replace(/_/g, '.');
            document.getElementById('uNewBalance').value = u.balance || 0;
            document.getElementById('moneyModal').style.display = 'flex';
        }

        function saveUserBalance() {
            let id = document.getElementById('uId').value;
            let newBal = Number(document.getElementById('uNewBalance').value);
            
            db.ref('users/' + id).update({ balance: newBal }).then(() => {
                showAdminToast("Đã thay đổi số dư ví của khách hàng thành công!");
                closeModal('moneyModal');
            });
        }

        function deleteUser(id) {
            if(confirm("⛔ LƯU Ý: Xóa người dùng sẽ làm mất vĩnh viễn số dư và lịch sử giao dịch của họ. BẠN CÓ CHẮC CHẮN KHÔNG?")) {
                db.ref('users/' + id).remove().then(() => {
                    showAdminToast("Đã tiêu diệt tài khoản này khỏi hệ thống.");
                });
            }
        }

        // ====================================
        // GỌI HÀM KHI VỪA VÀO TRANG ADMIN
        // ====================================
        window.onload = function() {
            loadProducts();
            loadUsers();
        };
    </script>
</body>
</html>
