<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đang tạo liên kết...</title>
    <style>
        body { background: #000; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; }
        .loader { border: 5px solid #333; border-top: 5px solid #00ff00; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        p { margin-top: 20px; color: #ffff00; }
        button { margin-top: 20px; padding: 10px 20px; cursor: pointer; display: none; }
    </style>
</head>
<body>
    <div class="loader"></div>
    <p id="status">Đang kết nối API Link4M...</p>
    <button onclick="location.reload()">Thử lại</button>

    <script>
        // --- CẤU HÌNH ---
        const API_TOKEN = "6992df868b3d1e423d1ab833"; 
        // Tên file trang đích thứ 2 (Phải upload file này lên cùng thư mục)
        const TARGET_PAGE = "key.html"; 
        // ----------------

        async function createLink() {
            const status = document.getElementById("status");
            
            // 1. Tự động lấy đường dẫn hiện tại và trỏ tới file key.html
            // Ví dụ: https://ban.github.io/tool/index.html -> https://ban.github.io/tool/key.html
            let currentPath = window.location.href;
            // Xóa index.html hoặc dấu / cuối cùng nếu có
            if (currentPath.endsWith("index.html")) {
                currentPath = currentPath.substring(0, currentPath.lastIndexOf("index.html"));
            } else if (!currentPath.endsWith("/")) {
                currentPath += "/";
            }
            
            const targetUrl = currentPath + TARGET_PAGE;
            console.log("Mục tiêu rút gọn:", targetUrl);

            // 2. Gọi API qua Proxy (allorigins) để tránh lỗi CORS và Link Error
            // Encode 2 lần để đảm bảo link không bị lỗi ký tự đặc biệt
            const finalApiUrl = `https://link4m.com/api-shorten/v2?api=${API_TOKEN}&url=${encodeURIComponent(targetUrl)}`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(finalApiUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                const data = await response.json();

                if (data.status === "success") {
                    status.innerText = "Đã tạo link xong! Đang chuyển hướng...";
                    // Chuyển hướng người dùng sang Link4M
                    window.location.href = data.shortenedUrl;
                } else {
                    status.innerText = "Lỗi từ Link4M: " + data.message;
                    document.querySelector("button").style.display = "block";
                }
            } catch (err) {
                console.error(err);
                status.innerText = "Lỗi kết nối! Đang thử phương thức dự phòng...";
                
                // Fallback: Nếu Proxy lỗi, dùng cách chuyển hướng trực tiếp qua API
                setTimeout(() => {
                    window.location.href = `https://link4m.com/api?api=${API_TOKEN}&url=${encodeURIComponent(targetUrl)}`;
                }, 1500);
            }
        }

        // Chạy ngay khi vào trang
        createLink();
    </script>
</body>
</html>
