<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>h·ªá th·ªëng key</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { background: #050505; color: #fff; font-family: 'Inter', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        .box { width: 350px; padding: 30px; border: 1px solid #333; border-radius: 20px; background: #111; text-align: center; box-shadow: 0 0 50px rgba(0, 255, 136, 0.1); }
        h2 { color: #00ff88; font-family: 'Orbitron'; margin-bottom: 5px; }
        .btn { width: 100%; padding: 15px; background: #fff; color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 20px; transition: 0.3s; }
        .btn:hover { background: #ccc; transform: scale(1.02); }
        
        .progress-container { width: 100%; background: #222; height: 6px; border-radius: 3px; margin-top: 20px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background: #00ff88; width: 0%; transition: width 0.3s; }
        .status { color: #ffff00; font-size: 12px; margin-top: 10px; display: none; font-family: monospace; }
        .error { color: #ff5555; font-size: 11px; margin-top: 10px; display: none; border: 1px solid #ff5555; padding: 5px; }
    </style>
</head>
<body>
    <div class="box">
        <h2>Key SYSTEM</h2>
        <p style="color:#666; font-size:12px">Secure Token 15m (Anti-Share)</p>

        <button id="btnGet" class="btn" onclick="generateSecureLink()">üöÄ L·∫§Y LINK B·∫¢O M·∫¨T</button>
        
        <div id="pBox" class="progress-container"><div id="pBar" class="progress-bar"></div></div>
        <div id="status" class="status">ƒêang kh·ªüi t·∫°o...</div>
        <div id="err" class="error"></div>
    </div>

    <script>
        // --- C·∫§U H√åNH ---
        const API_TOKEN = "6992df868b3d1e423d1ab833"; 
        const TARGET_FILE = "key.html"; 
        // ----------------

        const PROXY_LIST = [
            (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
            (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
            (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
            (u) => `https://thingproxy.freeboard.io/fetch/${u}`
        ];

        async function generateSecureLink() {
            if (window.location.protocol === 'file:') return alert("L·ªói: H√£y upload l√™n GitHub Pages!");

            const btn = document.getElementById('btnGet');
            const pBox = document.getElementById('pBox');
            const pBar = document.getElementById('pBar');
            const status = document.getElementById('status');
            const errDiv = document.getElementById('err');

            btn.style.display = 'none';
            errDiv.style.display = 'none';
            pBox.style.display = 'block';
            status.style.display = 'block';

            // 1. SINH M√É B·∫¢O M·∫¨T (TOKEN)
            // Token ng·∫´u nhi√™n + Timestamp
            const securityToken = Math.random().toString(36).substring(2) + Date.now().toString(36);
            
            // Th·ªùi gian h·∫øt h·∫°n c·ªßa link (15 ph√∫t t√≠nh t·ª´ l√∫c b·∫•m n√∫t)
            // ƒê·ªÉ kh·ªõp v·ªõi th·ªùi gian s·ªëng c·ªßa Key
            const expiryTime = Date.now() + (15 * 60 * 1000); 

            // 2. L∆ØU V√ÄO TR√åNH DUY·ªÜT (LocalStorage)
            // ƒê√¢y l√† ch√¨a kh√≥a: Ch·ªâ tr√¨nh duy·ªát n√†y m·ªõi c√≥ m√£ n√†y
            localStorage.setItem('secure_token', securityToken);
            localStorage.setItem('secure_expiry', expiryTime);

            // 3. T·∫†O LINK ƒê√çCH K√àM TOKEN
            let currentPath = window.location.href.split('?')[0];
            if (currentPath.endsWith("index.html")) currentPath = currentPath.substring(0, currentPath.lastIndexOf("index.html"));
            if (!currentPath.endsWith("/")) currentPath += "/";
            
            // Link s·∫Ω c√≥ d·∫°ng: .../key.html?t=abc123xyz&e=1700000000
            const targetUrl = `${currentPath}${TARGET_FILE}?t=${securityToken}&e=${expiryTime}`;
            
            console.log("Link g·ªëc:", targetUrl);

            // 4. G·ªåI API LINK4M
            const link4mApi = `https://link4m.co/api-shorten/v2?api=${API_TOKEN}&url=${encodeURIComponent(targetUrl)}`;
            
            let success = false;
            for (let i = 0; i < PROXY_LIST.length; i++) {
                status.innerText = `ƒêang k·∫øt n·ªëi Server ${i+1}...`;
                pBar.style.width = `${((i+1)/PROXY_LIST.length)*100}%`;
                
                try {
                    const controller = new AbortController();
                    setTimeout(() => controller.abort(), 6000);
                    const res = await fetch(PROXY_LIST[i](link4mApi), { signal: controller.signal });
                    
                    if(!res.ok) throw new Error();
                    const text = await res.text();
                    const data = JSON.parse(text); // C·ªë g·∫Øng parse JSON
                    
                    if (data.status === "success" && data.shortenedUrl) {
                        pBar.style.width = '100%';
                        status.innerText = "‚úÖ Th√†nh c√¥ng! ƒêang chuy·ªÉn h∆∞·ªõng...";
                        status.style.color = "#00ff88";
                        setTimeout(() => window.location.href = data.shortenedUrl, 800);
                        success = true;
                        break;
                    }
                } catch(e){}
                await new Promise(r => setTimeout(r, 200));
            }

            if (!success) {
                // Fallback th·ªß c√¥ng
                pBox.style.display = 'none';
                status.style.display = 'none';
                btn.style.display = 'block';
                btn.innerText = "T·∫†O TH·ª¶ C√îNG (SERVER B·∫¨N)";
                btn.onclick = () => window.open(`https://link4m.co/api?api=${API_TOKEN}&url=${encodeURIComponent(targetUrl)}`, '_blank');
                errDiv.style.display = 'block';
                errDiv.innerText = "Kh√¥ng th·ªÉ t·∫°o link t·ª± ƒë·ªông. Vui l√≤ng b·∫•m n√∫t tr√™n ƒë·ªÉ t·∫°o th·ªß c√¥ng.";
            }
        }
    </script>
</body>
</html>
