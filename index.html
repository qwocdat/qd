<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đang tạo liên kết...</title>
    <style>
        body { background: #000; color: #fff; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: sans-serif; }
        .loader { border: 4px solid #333; border-top: 4px solid #00ff88; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        p { margin-top: 20px; color: #00ff88; font-size: 14px; }
        .error { color: #ff3333; display: none; text-align: center; margin-top: 20px; }
        button { background: #333; color: #fff; border: 1px solid #555; padding: 10px 20px; cursor: pointer; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="loader" id="spin"></div>
    <p id="status">Đang kết nối API Link4M...</p>
    
    <div id="errorArea" class="error">
        <div>Không tạo được link tự động!</div>
        <div style="font-size:12px; color:#aaa; margin:5px 0">Lỗi: <span id="errMsg"></span></div>
        <button onclick="location.reload()">Thử lại</button>
    </div>

    <script>
        // --- CẤU HÌNH ---
        const API_TOKEN = "6992df868b3d1e423d1ab833"; 
        const TARGET_FILE = "key.html"; // Tên file đích
        // ----------------

        async function createLink() {
            // Chặn chạy offline
            if (window.location.protocol === 'file:') {
                showError("Vui lòng upload lên GitHub Pages!");
                return;
            }

            // 1. Xác định đường dẫn file key.html
            // Lấy URL thư mục hiện tại + key.html
            let currentPath = window.location.href;
            // Xóa index.html nếu có
            currentPath = currentPath.replace("index.html", "");
            // Đảm bảo có dấu / ở cuối
            if (!currentPath.endsWith("/")) currentPath += "/";
            
            const targetUrl = currentPath + TARGET_FILE;
            console.log("Mục tiêu:", targetUrl);

            // 2. Gọi API qua Proxy AllOrigins (Để sửa lỗi Link Error / No Alias)
            const link4mApi = `https://link4m.com/api-shorten/v2?api=${API_TOKEN}&url=${encodeURIComponent(targetUrl)}`;
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(link4mApi)}`;

            try {
                const response = await fetch(proxyUrl);
                const dataWrapper = await response.json();
                
                if (dataWrapper.contents) {
                    const data = JSON.parse(dataWrapper.contents);
                    
                    if (data.status === "success" && data.shortenedUrl) {
                        document.getElementById("status").innerText = "Thành công! Đang chuyển hướng...";
                        setTimeout(() => {
                            window.location.href = data.shortenedUrl;
                        }, 500);
                    } else {
                        throw new Error(data.message || "Link4M từ chối tạo link");
                    }
                } else {
                    throw new Error("Lỗi Proxy kết nối");
                }
            } catch (err) {
                console.error(err);
                document.getElementById("status").innerText = "Đang thử server dự phòng...";
                
                // Fallback: Chuyển hướng trực tiếp qua API Link4M (Phương án cuối cùng)
                setTimeout(() => {
                    window.location.href = `https://link4m.com/api?api=${API_TOKEN}&url=${encodeURIComponent(targetUrl)}`;
                }, 1000);
            }
        }

        function showError(msg) {
            document.getElementById("spin").style.display = "none";
            document.getElementById("status").style.display = "none";
            document.getElementById("errorArea").style.display = "block";
            document.getElementById("errMsg").innerText = msg;
            document.querySelector("button").style.display = "inline-block";
        }

        createLink();
    </script>
</body>
</html>
