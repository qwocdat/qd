<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CỔNG TRÍCH XUẤT LINK TẢI | QUOCDAT SEC</title>
    
    <script>
        var currentUser = localStorage.getItem('vip_username');
        if(!currentUser || currentUser.trim() === "") { window.location.replace("login.html"); }
        var safeUserId = currentUser.replace(/[.#$\[\]]/g, '_');
        window.goToPage = function(url) { window.location.href = url; }
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #00ff88; --bg: #0a0a0f; --card-bg: #15151e; --border: #2a2a35; --accent: #00b8ff; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; padding-top: 70px; padding-bottom: 50px; }
        
        header { position: fixed; top: 0; left: 0; width: 100%; height: 70px; background: rgba(10,10,15,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); z-index: 1000; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .logo { font-family: 'Orbitron'; font-size: 18px; font-weight: 900; color: #fff; text-decoration: none; cursor: pointer; }
        .pc-wallet { background: rgba(0,255,136,0.1); border: 1px solid var(--primary); color: var(--primary); padding: 8px 15px; border-radius: 30px; font-size: 14px; font-family: 'Orbitron'; font-weight: bold; }

        .container { max-width: 700px; margin: 50px auto; padding: 0 20px; text-align: center; }
        .search-section { background: var(--card-bg); border: 1px solid var(--border); padding: 40px 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        
        .title-box { font-family: 'Orbitron'; font-size: 24px; color: var(--primary); margin-bottom: 10px; text-transform: uppercase; }
        .desc-box { color: #888; font-size: 14px; margin-bottom: 30px; line-height: 1.6; }

        .input-group { position: relative; margin-bottom: 20px; }
        .input-group i { position: absolute; top: 50%; left: 20px; transform: translateY(-50%); color: #f1c40f; font-size: 20px; }
        .key-input { width: 100%; background: #050508; border: 2px solid #333; color: #f1c40f; padding: 18px 20px 18px 55px; border-radius: 12px; font-size: 16px; font-family: monospace; font-weight: bold; outline: none; transition: 0.3s; letter-spacing: 1px; }
        .key-input:focus { border-color: #f1c40f; box-shadow: 0 0 15px rgba(241,196,15,0.2); }
        .key-input::placeholder { color: #555; font-weight: normal; letter-spacing: 0; }

        .btn-check { background: var(--primary); color: #000; padding: 15px 30px; border-radius: 12px; font-weight: bold; font-family: 'Orbitron'; border: none; cursor: pointer; font-size: 16px; width: 100%; transition: 0.3s; }
        .btn-check:hover { filter: brightness(1.2); }

        /* KẾT QUẢ TRẢ VỀ */
        .result-card { display: none; margin-top: 30px; padding-top: 30px; border-top: 1px dashed var(--border); text-align: left; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        
        .r-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .r-icon { width: 50px; height: 50px; background: rgba(0,255,136,0.1); border-radius: 12px; display: flex; justify-content: center; align-items: center; color: var(--primary); font-size: 24px; }
        .r-info { flex: 1; }
        .r-name { font-weight: bold; font-size: 18px; margin-bottom: 5px; color: #fff; }
        .r-type { font-size: 12px; font-family: monospace; background: #222; padding: 3px 8px; border-radius: 5px; display: inline-block; }

        .btn-download { display: block; width: 100%; text-align: center; background: #1e90ff; color: #fff; padding: 15px; border-radius: 12px; text-decoration: none; font-weight: bold; font-family: 'Orbitron'; transition: 0.3s; font-size: 16px; margin-top: 10px; }
        .btn-download:hover { background: #007bff; box-shadow: 0 5px 15px rgba(30,144,255,0.4); }

        .error-msg { display: none; margin-top: 20px; padding: 15px; background: rgba(255,71,87,0.1); border: 1px dashed #ff4757; color: #ff4757; border-radius: 10px; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>
      <header>
        <div class="logo" onclick="window.goToPage('index.html')"><i class="fas fa-arrow-left" style="color:#888; margin-right:10px;"></i> VỀ TRANG CHỦ</div>
        <div class="pc-wallet" id="pcBal">0 đ</div>
    </header>

    <div class="container">
        <div class="search-section">
            <i class="fas fa-cloud-download-alt" style="font-size: 50px; color: var(--primary); margin-bottom: 20px;"></i>
            <div class="title-box">CỔNG TRÍCH XUẤT LINK</div>
            <div class="desc-box">Vui lòng nhập mã KEY (Bản quyền VIP hoặc Key dùng thử Free) mà bạn đang sở hữu để hệ thống tiến hành giải mã và cấp phát Link tải file an toàn.</div>

            <div class="input-group">
                <i class="fas fa-key"></i>
                <input type="text" id="inputKey" class="key-input" placeholder="Nhập mã KEY (VD: QDSEC-XXXX hoặc QDFREE-XXXX)" autocomplete="off">
            </div>

            <button class="btn-check" id="btnSubmit" onclick="extractLink()">
                <i class="fas fa-search"></i> KIỂM TRA KEY & LẤY LINK
            </button>

            <div class="error-msg" id="errorMsg">
                <i class="fas fa-times-circle"></i> Mã KEY không tồn tại, đã hết hạn hoặc không thuộc về bạn!
            </div>

            <div class="result-card" id="resultCard">
                <div class="r-header">
                    <div class="r-icon"><i class="fas fa-box-open"></i></div>
                    <div class="r-info">
                        <div class="r-name" id="resName">Tên Sản Phẩm Ở Đây</div>
                        <div class="r-type" id="resType" style="color:#f1c40f;">Loại KEY: Đang kiểm tra...</div>
                    </div>
                </div>
                
                <div style="background:#111; padding:15px; border-radius:10px; border:1px solid #333; margin-bottom:15px;">
                    <div style="font-size:12px; color:#888; margin-bottom:5px;">Trạng thái trích xuất:</div>
                    <div style="color:var(--primary); font-weight:bold; font-size:14px;"><i class="fas fa-check-circle"></i> Đã tìm thấy File gốc từ Server</div>
                </div>

                <a href="#" target="_blank" class="btn-download" id="btnDownloadLink">
                    <i class="fas fa-download"></i> TẢI XUỐNG NGAY
                </a>
            </div>
        </div>
    </div>
        <script>
        const firebaseConfig = { apiKey: "AIzaSyAWaCeduRtSP74OkRYJ6wvw8LPPkoLGsGc", databaseURL: "https://quocdat-b80c2-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "quocdat-b80c2" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. ĐỒNG BỘ SỐ DƯ GÓC PHẢI
        if(safeUserId !== "guest") {
            db.ref('users/' + safeUserId).on('value', (snap) => {
                if(snap.exists()) document.getElementById('pcBal').innerText = (snap.val().balance || 0).toLocaleString('vi-VN') + " đ";
            });
        }

        // 2. HÀM QUÉT KEY TỪ LỊCH SỬ GIAO DỊCH
        function extractLink() {
            let keyToSearch = document.getElementById('inputKey').value.trim().toUpperCase();
            let btn = document.getElementById('btnSubmit');
            let errorBox = document.getElementById('errorMsg');
            let resultBox = document.getElementById('resultCard');

            if(!keyToSearch) {
                alert("Vui lòng nhập mã KEY!");
                return;
            }

            // Reset UI
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ĐANG GIẢI MÃ...`;
            btn.disabled = true;
            errorBox.style.display = 'none';
            resultBox.style.display = 'none';

            // Quét trong bảng Lịch sử (transactions) để tìm xem có KEY này không
            db.ref('transactions').orderByChild('key_granted').equalTo(keyToSearch).once('value')
            .then((snapshot) => {
                btn.innerHTML = `<i class="fas fa-search"></i> KIỂM TRA KEY & LẤY LINK`;
                btn.disabled = false;

                if(snapshot.exists()) {
                    let transactionData = null;
                    
                    // Lấy ra data của giao dịch chứa KEY đó
                    snapshot.forEach(child => { 
                        let temp = child.val();
                        // (Bảo mật kép) Chỉ trả link nếu KEY đó thuộc về chính User đang đăng nhập!
                        if(temp.user === safeUserId) {
                            transactionData = temp;
                        }
                    });

                    if(transactionData) {
                        // Đã tìm thấy hàng chuẩn!
                        
                        // Lọc tên sản phẩm (Xóa chữ "Mua: " hoặc "Nhận Miễn Phí: ")
                        let cleanName = transactionData.detail.replace('Mua: ', '').replace('Nhận Miễn Phí: ', '');
                        document.getElementById('resName').innerText = cleanName;

                        // Phân loại KEY (VIP hay Free) để hiển thị màu
                        let typeText = transactionData.type === 'purchase' && transactionData.amount > 0 ? "Bản Quyền VIP (Vĩnh Viễn)" : "Dùng Thử FREE (24H)";
                        let typeColor = transactionData.amount > 0 ? "#f1c40f" : "var(--primary)";
                        
                        let typeBadge = document.getElementById('resType');
                        typeBadge.innerText = typeText;
                        typeBadge.style.color = typeColor;

                        // Gắn Link Tải
                        let dlLink = transactionData.download_link;
                        let btnDl = document.getElementById('btnDownloadLink');
                        if(dlLink && dlLink !== "#" && dlLink !== "") {
                            btnDl.href = dlLink;
                            btnDl.style.background = "#1e90ff";
                            btnDl.innerHTML = `<i class="fas fa-download"></i> TẢI XUỐNG NGAY`;
                            btnDl.onclick = null; // Gỡ bỏ sự kiện click cũ nếu có
                        } else {
                            btnDl.href = "javascript:void(0);";
                            btnDl.style.background = "#333";
                            btnDl.innerHTML = `<i class="fas fa-exclamation-triangle"></i> LINK CHƯA CẬP NHẬT`;
                            btnDl.onclick = function() { alert("Admin chưa up link tải cho bản cập nhật này. Vui lòng chờ!"); };
                        }

                        // Hiển thị kết quả
                        resultBox.style.display = 'block';

                    } else {
                        // Key tồn tại nhưng của thằng khác mua
                        errorBox.innerHTML = `<i class="fas fa-user-shield"></i> Cảnh báo: KEY này đã được mua bởi một tài khoản khác!`;
                        errorBox.style.display = 'block';
                    }

                } else {
                    // Không tìm thấy KEY trong database
                    errorBox.innerHTML = `<i class="fas fa-times-circle"></i> Mã KEY không tồn tại hoặc đã hết hạn!`;
                    errorBox.style.display = 'block';
                }
            })
            .catch(err => {
                alert("Lỗi truy xuất hệ thống!");
                btn.innerHTML = `<i class="fas fa-search"></i> KIỂM TRA KEY & LẤY LINK`;
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
