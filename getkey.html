<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>V∆Ø·ª¢T LINK PRO</title>
    <!-- gi·ªØ nguy√™n c√°c th·∫ª meta, css, firebase, font -->
    <style> /* gi·ªØ nguy√™n style c≈© */ </style>
</head>
<body>
    <header>...</header>
    <div class="container">...</div>

    <script>
        const MY_API_KEY = "6992df868b3d1e423d1ab833";
        const firebaseConfig = { ... };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // H√†m g·ªçi JSONP (d√†nh cho /api)
        function jsonpRequest(url, callbackName) {
            return new Promise((resolve, reject) => {
                const cbName = callbackName + '_' + Date.now();
                window[cbName] = function(data) {
                    resolve(data);
                    cleanup();
                };
                const script = document.createElement('script');
                script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cbName;
                script.async = true;
                const timeout = setTimeout(() => {
                    cleanup();
                    reject(new Error('JSONP timeout'));
                }, 8000);
                script.onerror = () => { cleanup(); reject(new Error('JSONP network error')); };
                document.head.appendChild(script);
                function cleanup() {
                    if (script.parentNode) script.parentNode.removeChild(script);
                    delete window[cbName];
                    clearTimeout(timeout);
                }
            });
        }

        // H√†m th·ª≠ t·ª´ng ph∆∞∆°ng th·ª©c
        async function tryAllMethods(destinationUrl) {
            // Ph∆∞∆°ng th·ª©c 1: G·ªçi /api b·∫±ng JSONP (n·∫øu link4m h·ªó tr·ª£ callback)
            try {
                const apiUrl = `https://link4m.com/api?api=${MY_API_KEY}&url=${encodeURIComponent(destinationUrl)}`;
                const data = await jsonpRequest(apiUrl, 'link4m_callback');
                // ƒê·ªãnh d·∫°ng response c√≥ th·ªÉ kh√°c nhau: th·ª≠ c√°c tr∆∞·ªùng ph·ªï bi·∫øn
                const shortLink = data.shortenedUrl || data.shortlink || data.url || (data.status === 'success' && data.link);
                if (shortLink) {
                    console.log('‚úÖ Th√†nh c√¥ng qua /api JSONP');
                    window.location.href = shortLink;
                    return true;
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è /api JSONP th·∫•t b·∫°i:', e);
            }

            // Ph∆∞∆°ng th·ª©c 2: D√πng fetch v·ªõi proxy CORS (n·∫øu c√≥ server proxy)
            // (·ªû ƒë√¢y gi·∫£ s·ª≠ b·∫°n c√≥ file proxy.php c√πng th∆∞ m·ª•c)
            try {
                const proxyUrl = `proxy.php?api=${MY_API_KEY}&url=${encodeURIComponent(destinationUrl)}`;
                const res = await fetch(proxyUrl);
                const data = await res.json();
                const shortLink = data.shortenedUrl || data.shortlink || data.url;
                if (shortLink) {
                    console.log('‚úÖ Th√†nh c√¥ng qua proxy PHP');
                    window.location.href = shortLink;
                    return true;
                }
            } catch (e) {
                console.warn('‚ö†Ô∏è Proxy th·∫•t b·∫°i:', e);
            }

            // Ph∆∞∆°ng th·ª©c 3: Redirect tr·ª±c ti·∫øp ƒë·∫øn /st (c√°ch c≈©)
            try {
                const stUrl = `https://link4m.com/st?api=${MY_API_KEY}&url=${encodeURIComponent(destinationUrl)}`;
                console.log('üîÑ Th·ª≠ redirect ƒë·∫øn /st');
                window.location.href = stUrl;
                return true; // Kh√¥ng th·ªÉ ki·ªÉm tra th√†nh c√¥ng, nh∆∞ng hy v·ªçng redirect ho·∫°t ƒë·ªông
            } catch (e) {
                console.error('‚ùå /st redirect th·∫•t b·∫°i:', e);
            }

            return false;
        }

        async function forceGenerateLink() {
            const btn = document.getElementById('btnCreateLink');
            const status = document.getElementById('loadingStatus');
            const errorMsg = document.getElementById('errorMsg');

            btn.style.display = 'none';
            status.style.display = 'block';
            errorMsg.style.display = 'none';

            const uniqueToken = "TK-" + Math.random().toString(36).substring(2, 12).toUpperCase();
            const freeKey = "QDFREE-" + Math.random().toString(36).substring(2, 8).toUpperCase();
            const urlParams = new URLSearchParams(window.location.search);
            const freeItem = urlParams.get('free_item');
            let currentPath = window.location.href.split('?')[0];
            let baseUrl = currentPath.substring(0, currentPath.lastIndexOf('/'));
            let destinationUrl = `${baseUrl}/key.html?verify=${uniqueToken}`;
            if (freeItem) destinationUrl += `&free_item=${freeItem}`;

            try {
                await db.ref('free_tokens/' + uniqueToken).set({ key: freeKey, status: 'pending', created_at: Date.now() });

                // Th·ª≠ l·∫ßn l∆∞·ª£t c√°c ph∆∞∆°ng th·ª©c
                const success = await tryAllMethods(destinationUrl);
                if (!success) {
                    throw new Error('T·∫•t c·∫£ ph∆∞∆°ng th·ª©c ƒë·ªÅu th·∫•t b·∫°i');
                }
            } catch (err) {
                console.error('L·ªói nghi√™m tr·ªçng:', err);
                errorMsg.style.display = 'block';
                btn.style.display = 'block';
                status.style.display = 'none';
            }
        }
    </script>
</body>
</html>
