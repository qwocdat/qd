<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ADMIN PANEL | QUOCDAT SEC</title>
    
    <script>
        var isAdminLoggedIn = sessionStorage.getItem('admin_auth_status');
        if (isAdminLoggedIn !== 'success') {
            var password = prompt("⛔ HỆ THỐNG BẢO MẬT CẤP CAO\n\nVui lòng nhập mật khẩu Quản Trị Viên:");
            if (password === "ngdaiquocdat") {
                sessionStorage.setItem('admin_auth_status', 'success');
                alert("✅ Xác thực thành công!");
            } else {
                alert("❌ Mật khẩu sai!");
                window.location.replace("index.html");
            }
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function switchTab(tabId, el) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            let titles = {'dashboard':'TỔNG QUAN & CÀI ĐẶT', 'products':'QUẢN LÝ SẢN PHẨM', 'users':'QUẢN LÝ NGƯỜI DÙNG', 'history':'QUẢN LÝ KEY & LỊCH SỬ'};
            document.getElementById('pageTitle').innerText = titles[tabId];
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function logoutAdmin() { sessionStorage.removeItem('admin_auth_status'); window.location.replace('index.html'); }
        function showAdminToast(msg, isError = false) {
            let t = document.getElementById('toastMsg');
            t.style.borderLeftColor = isError ? '#ff4757' : '#00ff88';
            t.innerHTML = `<i class="fas ${isError ? 'fa-times-circle' : 'fa-check-circle'}"></i> ${msg}`;
            t.classList.add('show');
            setTimeout(() => { t.classList.remove('show'); }, 3000);
        }
        function formatMoney(num) { return Number(num).toLocaleString('vi-VN') + " đ"; }
    </script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #ff4757; --bg: #050508; --card-bg: #111; --border: #222; --accent: #00ff88; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: #fff; display: flex; height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #000; } ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        .sidebar { width: 260px; background: #0a0a0f; border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; z-index: 1000; }
        .brand { padding: 20px; font-family: 'Orbitron'; font-size: 20px; font-weight: 900; color: #fff; text-align: center; border-bottom: 1px solid var(--border); }
        .brand span { color: var(--primary); }
        .nav-menu { padding: 15px; flex: 1; overflow-y: auto; }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; color: #aaa; text-decoration: none; border-radius: 10px; margin-bottom: 5px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .nav-item.active { background: rgba(255,71,87,0.1); color: var(--primary); }
        
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .topbar { height: 70px; background: rgba(10,10,15,0.9); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        .content-area { padding: 20px; overflow-y: auto; flex: 1; }
        .tab-pane { display: none; } .tab-pane.active { display: block; animation: fadeIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .stat-grid, .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 15px; border: 1px solid var(--border); margin-bottom: 20px; }
        .card-title { font-family: 'Orbitron'; margin-bottom: 15px; font-size: 16px; }
        .stat-card { display: flex; align-items: center; gap: 15px; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 20px; }
        
        .table-container { background: var(--card-bg); border-radius: 15px; border: 1px solid var(--border); overflow-x: auto; margin-bottom: 20px; }
        .table-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .btn, .btn-add { background: var(--primary); color: #fff; padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-family: 'Orbitron'; transition: 0.2s;}
        .btn:hover, .btn-add:hover { filter: brightness(1.2); }
        
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #1a1a24; padding: 15px; text-align: left; font-size: 12px; color: #888; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        .action-btn { background: #222; border: 1px solid #333; color: #fff; width: 32px; height: 32px; border-radius: 6px; cursor: pointer; margin-right: 5px; transition: 0.2s; }
        .action-btn.edit:hover { background: #1e90ff; border-color: #1e90ff; }
        .action-btn.money:hover { background: var(--accent); border-color: var(--accent); color: #000; }
        .action-btn.ban:hover { background: #f1c40f; border-color: #f1c40f; color: #000; }
        
        .form-group { margin-bottom: 15px; } 
        .form-group label { display: block; font-size: 12px; color: #aaa; margin-bottom: 8px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; background: #0a0a0f; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; outline: none; }
        input[type="color"] { padding: 0; height: 42px; cursor: pointer; }
        .toggle-container { display: flex; align-items: center; justify-content: space-between; background: #000; padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; display: none; align-items: center; justify-content: center; }
        .modal-box { width: 90%; max-width: 500px; background: #15151e; border-radius: 15px; border: 1px solid #333; overflow: hidden; }
        .modal-head { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; background: #111; }
        .modal-body { padding: 20px; max-height: 70vh; overflow-y: auto;}
        .modal-footer { padding: 20px; border-top: 1px solid #333; display: flex; justify-content: flex-end; gap: 10px; background: #111; }
        
        .toast { position: fixed; bottom: 20px; right: -300px; background: #111; border-left: 4px solid var(--primary); color: #fff; padding: 15px 25px; border-radius: 8px; font-weight: bold; transition: 0.4s; z-index: 10000; }
        .toast.show { right: 20px; }
        .mobile-toggle { display: none; } 
        @media (max-width: 768px) { .sidebar { position: fixed; left: -260px; height: 100vh; } .sidebar.open { left: 0; } .mobile-toggle { display: block; } }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="brand" style="display:flex; justify-content:space-between;"><div>QUOCDAT<span>.ADMIN</span></div><i class="fas fa-times mobile-toggle" onclick="toggleSidebar()"></i></div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchTab('dashboard', this)"><i class="fas fa-chart-pie"></i> Tổng Quan & Cài Đặt</div>
            <div class="nav-item" onclick="switchTab('products', this)"><i class="fas fa-box-open"></i> Quản Lý Sản Phẩm</div>
            <div class="nav-item" onclick="switchTab('users', this)"><i class="fas fa-users"></i> Quản Lý User & Khóa</div>
            <div class="nav-item" onclick="switchTab('history', this)"><i class="fas fa-key"></i> Quản Lý KEY & Lịch Sử</div>
            <a href="download.html" target="_blank" class="nav-item" style="border-top:1px dashed #333; margin-top:15px; color:#1e90ff;"><i class="fas fa-external-link-alt"></i> Mở Cổng Trích Xuất</a>
            <div class="nav-item" style="color:#ff4757; margin-top:10px;" onclick="logoutAdmin()"><i class="fas fa-sign-out-alt"></i> Đăng Xuất</div>
        </div>
    </div>

    <div class="main-content">
        <div class="topbar">
            <div style="display:flex; align-items:center; gap:15px;"><i class="fas fa-bars mobile-toggle" onclick="toggleSidebar()"></i><div class="page-title" id="pageTitle">TỔNG QUAN & CÀI ĐẶT</div></div>
            <a href="index.html" style="color:#fff; text-decoration:none; font-size:12px; border:1px solid #333; padding:8px 15px; border-radius:8px; background:#111;">Về Trang Chủ</a>
        </div>

        <div class="content-area">
            <div id="tab-dashboard" class="tab-pane active">
                <div class="stat-grid">
                    <div class="card stat-card" style="margin:0;"><div class="stat-icon" style="background:rgba(0,255,136,0.1); color:var(--accent);"><i class="fas fa-wallet"></i></div><div><div style="font-size:11px; color:#888;">TỔNG NẠP</div><div id="statRevenue" style="font-size:20px; font-weight:bold; font-family:'Orbitron';">0 đ</div></div></div>
                    <div class="card stat-card" style="margin:0;"><div class="stat-icon" style="background:rgba(30,144,255,0.1); color:#1e90ff;"><i class="fas fa-users"></i></div><div><div style="font-size:11px; color:#888;">USER ĐĂNG KÝ</div><div id="statUsers" style="font-size:20px; font-weight:bold; font-family:'Orbitron';">0</div></div></div>
                    <div class="card stat-card" style="margin:0;"><div class="stat-icon" style="background:rgba(255,71,87,0.1); color:var(--primary);"><i class="fas fa-box"></i></div><div><div style="font-size:11px; color:#888;">SẢN PHẨM</div><div id="statProducts" style="font-size:20px; font-weight:bold; font-family:'Orbitron';">0</div></div></div>
                </div>

                <div class="card" style="border-color: #ff4757;">
                    <h3 class="card-title" style="color: #ff4757;"><i class="fas fa-cogs"></i> CÀI ĐẶT HỆ THỐNG & BẢO TRÌ</h3>
                    <div class="toggle-container" style="margin-bottom: 20px;">
                        <div>
                            <strong style="color: #ff4757; font-size: 16px;">CHẾ ĐỘ BẢO TRÌ (ĐÓNG CỬA WEB)</strong>
                            <p style="font-size: 12px; color: #888; margin-top: 5px;">Khách sẽ không thể lấy Key khi bật tính năng này.</p>
                        </div>
                        <input type="checkbox" id="maintenanceMode" style="width: 25px; height: 25px; accent-color: #ff4757;">
                    </div>
                    <div class="grid-3">
                        <div class="form-group"><label>Tên Thương Hiệu (Title):</label><input type="text" id="siteName" placeholder="VD: QUOCDAT SEC"></div>
                        <div class="form-group" style="grid-column: span 2;"><label>Tiêu đề trang Get Key:</label><input type="text" id="getKeyTitle" placeholder="VD: ANTI-BOT SYSTEM"></div>
                    </div>
                    <label style="margin-top: 10px; display:block; color:#00b8ff;"><i class="fas fa-stopwatch"></i> Thời gian đếm ngược (Giây):</label>
                    <div class="grid-3">
                        <div class="form-group"><label>Bước 1:</label><input type="number" id="time1"></div>
                        <div class="form-group"><label>Bước 2:</label><input type="number" id="time2"></div>
                        <div class="form-group"><label>Bước 3:</label><input type="number" id="time3"></div>
                    </div>
                    <button class="btn" style="width: 100%; margin-top:10px;" onclick="saveSettings()"><i class="fas fa-save"></i> LƯU CẤU HÌNH HỆ THỐNG</button>
                </div>

                <div class="card" style="border-color: #1e90ff;">
                    <h3 class="card-title" style="color: #1e90ff;"><i class="fas fa-code"></i> TRÌNH SOẠN THẢO MÃ NGUỒN</h3>
                    <p style="color:#888; font-size:13px; margin-bottom:15px;">Dán mã HTML/CSS/JS mới vào đây để thay đổi giao diện các trang khác.</p>
                    <div class="form-group">
                        <select id="pageSelect" onchange="loadRawCode()"><option value="getkey_html">Trang getkey.html</option><option value="key_html">Trang key.html</option><option value="index_html">Trang index.html</option></select>
                    </div>
                    <textarea id="rawCodeArea" rows="8" placeholder="Dán code HTML mới của bạn vào đây..."></textarea>
                    <button class="btn" style="background: #1e90ff; width: 100%; margin-top:10px;" onclick="saveRawCode()"><i class="fas fa-cloud-upload-alt"></i> CẬP NHẬT MÃ NGUỒN</button>
                </div>
            </div>

            <div id="tab-products" class="tab-pane">
                <div class="table-container">
                    <div class="table-header"><h3>Kho Sản Phẩm</h3><button class="btn-add" onclick="openProductModal()"><i class="fas fa-plus"></i> Thêm Mới</button></div>
                    <table><thead><tr><th width="60">ID</th><th>Tên Sản Phẩm</th><th>Giá Bán</th><th width="100">Thao Tác</th></tr></thead><tbody id="productTableBody"></tbody></table>
                </div>
            </div>

            <div id="tab-users" class="tab-pane">
                <div class="table-container">
                    <div class="table-header"><h3>Danh Sách Người Dùng</h3></div>
                    <table><thead><tr><th>Tài Khoản</th><th>Số Dư</th><th>Trạng Thái</th><th width="120">Thao Tác</th></tr></thead><tbody id="userTableBody"></tbody></table>
                </div>
            </div>

            <div id="tab-history" class="tab-pane">
                
                <div class="card" style="border-color: #f1c40f;">
                    <h3 class="card-title" style="color: #f1c40f;"><i class="fas fa-crown"></i> TẠO KEY VIP THỦ CÔNG</h3>
                    <p style="color:#888; font-size:13px; margin-bottom:15px;">Tạo mã Key giao thẳng cho khách không cần vượt link.</p>
                    <div class="grid-3">
                        <div class="form-group"><label>Mã Key tùy ý (VD: VIP-QUOCDAT):</label><input type="text" id="customKeyStr" placeholder="Nhập mã Key..."></div>
                        <div class="form-group"><label>Ngày giờ hết hạn:</label><input type="datetime-local" id="customKeyExp"></div>
                        <div class="form-group"><label>Màu sắc hiển thị:</label><input type="color" id="customKeyColor" value="#f1c40f" style="width: 100%;"></div>
                    </div>
                    <div class="form-group">
                        <label>Gắn quyền tải công cụ nào?</label>
                        <select id="customKeyProduct"><option value="">-- Đang tải dữ liệu --</option></select>
                    </div>
                    <button class="btn" style="background: #f1c40f; color: #000; width: 100%; margin-top:10px;" onclick="createManualKey()"><i class="fas fa-magic"></i> TẠO KEY NGAY</button>
                </div>

                <div class="table-container">
                    <div class="table-header"><h3>Lịch Sử Cấp Phát KEY</h3></div>
                    <table><thead><tr><th>Thời Gian</th><th>Tài Khoản</th><th>Tên Sản Phẩm</th><th>Mã KEY</th><th>Link Tải</th></tr></thead><tbody id="historyTableBody"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="productModal"><div class="modal-box"><div class="modal-head"><div class="modal-title" style="color:var(--primary)">THÊM SẢN PHẨM</div><button style="background:none; border:none; color:#fff;" onclick="closeModal('productModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><input type="hidden" id="pId"><div class="form-group"><label>Tên Sản Phẩm *</label><input type="text" id="pName"></div><div class="form-group"><label>Danh Mục</label><select id="pCategory"><option value="Tool Social">Tool Social</option><option value="Script Game">Script Game</option></select></div><div class="form-group"><label>Giá (VNĐ) - Nhập 0 nếu Free *</label><input type="number" id="pPrice"></div><div class="form-group"><label>Link Tải *</label><input type="text" id="pDownload"></div><div class="form-group"><label>Mô Tả</label><textarea id="pDesc" rows="2"></textarea></div><div class="form-group"><label>Icon (FontAwesome)</label><input type="text" id="pImg" value="fas fa-box"></div></div><div class="modal-footer"><button class="btn" style="background:#333;" onclick="closeModal('productModal')">Hủy</button><button class="btn" onclick="saveProduct()">LƯU</button></div></div></div>
    <div class="modal-overlay" id="moneyModal"><div class="modal-box"><div class="modal-head"><div class="modal-title" style="color:var(--accent);">CẬP NHẬT SỐ DƯ</div><button style="background:none; border:none; color:#fff;" onclick="closeModal('moneyModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><input type="hidden" id="uId"><div style="margin-bottom:15px; color:#fff;">Tài khoản: <strong id="uNameDisplay"></strong></div><div class="form-group"><label>Số dư mới (VNĐ) *</label><input type="number" id="uNewBalance"></div></div><div class="modal-footer"><button class="btn" style="background:#333;" onclick="closeModal('moneyModal')">Hủy</button><button class="btn" style="background:var(--accent); color:#000;" onclick="saveUserBalance()">CẬP NHẬT</button></div></div></div>
    <div class="modal-overlay" id="banModal"><div class="modal-box" style="border-color:#ff9f43;"><div class="modal-head" style="background:#2d1b00;"><div class="modal-title" style="color:#ff9f43;"><i class="fas fa-lock"></i> KHÓA TÀI KHOẢN</div><button style="background:none; border:none; color:#fff;" onclick="closeModal('banModal')"><i class="fas fa-times"></i></button></div><div class="modal-body"><input type="hidden" id="banUid"><div class="form-group"><label>Lý do khóa *</label><input type="text" id="banReason"></div></div><div class="modal-footer"><button id="btnUnbanBtn" class="btn" style="background:#222; color:var(--accent); display:none;" onclick="unbanUser()">MỞ KHÓA</button><button class="btn" style="background:#ff9f43; color:#000;" onclick="executeBan()">KHÓA</button></div></div></div>
    <div class="toast" id="toastMsg">Thành công!</div>
        <script>
        const firebaseConfig = { apiKey: "AIzaSyAWaCeduRtSP74OkRYJ6wvw8LPPkoLGsGc", databaseURL: "https://quocdat-b80c2-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "quocdat-b80c2" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. LOAD & LƯU CÀI ĐẶT BẢO TRÌ/TIME
        db.ref('settings').on('value', snap => {
            let data = snap.val() || {};
            document.getElementById('siteName').value = data.site_name || '';
            document.getElementById('getKeyTitle').value = data.getkey_title || '';
            document.getElementById('time1').value = data.time_step_1 || 10;
            document.getElementById('time2').value = data.time_step_2 || 15;
            document.getElementById('time3').value = data.time_step_3 || 20;
            document.getElementById('maintenanceMode').checked = data.maintenance || false;
        });

        function saveSettings() {
            db.ref('settings').update({
                site_name: document.getElementById('siteName').value,
                getkey_title: document.getElementById('getKeyTitle').value,
                time_step_1: parseInt(document.getElementById('time1').value),
                time_step_2: parseInt(document.getElementById('time2').value),
                time_step_3: parseInt(document.getElementById('time3').value),
                maintenance: document.getElementById('maintenanceMode').checked
            }).then(() => showAdminToast("Lưu cấu hình hệ thống thành công!"));
        }

        // 2. SẢN PHẨM VÀ SELECT CHO TẠO KEY
        let currentProducts = {};
        db.ref('products').on('value', (s) => {
            let tbody = document.getElementById('productTableBody'); tbody.innerHTML = ''; 
            let keySelect = document.getElementById('customKeyProduct'); keySelect.innerHTML = '<option value="">-- Chọn công cụ (Bắt buộc) --</option>';
            let pCount = 0;
            if(s.exists()) {
                currentProducts = s.val();
                for(let id in currentProducts) {
                    let p = currentProducts[id]; pCount++;
                    let priceText = p.price > 0 ? formatMoney(p.price) : '<span style="color:var(--primary);">MIỄN PHÍ</span>';
                    tbody.innerHTML += `<tr><td><strong style="color:var(--primary)">#${id.substring(0,4)}</strong></td><td style="font-weight:bold;">${p.name}</td><td style="color:var(--accent); font-weight:bold; font-family:monospace;">${priceText}</td><td><button class="action-btn edit" onclick="openProductModal('${id}')"><i class="fas fa-edit"></i></button><button class="action-btn delete" onclick="deleteProduct('${id}')" style="background:#ff4757; border-color:#ff4757;"><i class="fas fa-trash"></i></button></td></tr>`;
                    keySelect.innerHTML += `<option value="${id}">${p.name}</option>`;
                }
            } else { tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Trống</td></tr>`; }
            document.getElementById('statProducts').innerText = pCount;
        });

        function openProductModal(id = null) {
            document.getElementById('pId').value = ''; document.getElementById('pName').value = ''; document.getElementById('pPrice').value = ''; document.getElementById('pDesc').value = ''; document.getElementById('pDownload').value = '';
            if(id) { let p = currentProducts[id]; document.getElementById('pId').value = id; document.getElementById('pName').value = p.name; document.getElementById('pPrice').value = p.price; document.getElementById('pDownload').value = p.download_link || ''; }
            document.getElementById('productModal').style.display = 'flex';
        }

        function saveProduct() {
            let id = document.getElementById('pId').value; 
            let data = { name: document.getElementById('pName').value, price: Number(document.getElementById('pPrice').value), download_link: document.getElementById('pDownload').value };
            if(!data.name || data.download_link === "") return alert("Điền đủ Tên và Link tải!");
            if(id) db.ref('products/' + id).update(data).then(() => { showAdminToast("Cập nhật SP xong"); closeModal('productModal'); });
            else db.ref('products').push().set(data).then(() => { showAdminToast("Đã thêm SP mới"); closeModal('productModal'); });
        }
        function deleteProduct(id) { if(confirm("Xóa sản phẩm này?")) db.ref('products/' + id).remove().then(() => showAdminToast("Đã xóa")); }

        // 3. TẠO KEY VIP THỦ CÔNG
        async function createManualKey() {
            let keyStr = document.getElementById('customKeyStr').value.trim();
            let expVal = document.getElementById('customKeyExp').value;
            let color = document.getElementById('customKeyColor').value;
            let pId = document.getElementById('customKeyProduct').value;

            if(!keyStr || !expVal || !pId) return alert("Vui lòng nhập Mã Key, Thời hạn và Chọn công cụ!");
            let expTimestamp = new Date(expVal).getTime();
            if(expTimestamp <= Date.now()) return alert("Hạn sử dụng phải lớn hơn hiện tại!");

            let pSnap = await db.ref('products/' + pId).once('value');
            let pData = pSnap.val();

            let newTx = {
                user: 'ADMIN_VIP_SPAWN',
                type: 'vip_purchase', amount: 0, detail: 'Cấp KEY VIP: ' + pData.name,
                key_granted: keyStr, download_link: pData.download_link,
                expiry_at: expTimestamp, color: color, time: new Date().toISOString()
            };

            await db.ref('transactions').push().set(newTx);
            showAdminToast("Tạo KEY VIP thành công!");
            document.getElementById('customKeyStr').value = ''; // Reset ô nhập
        }

        // 4. LỊCH SỬ GIAO DỊCH & KEY (HỖ TRỢ HIỂN THỊ MÀU KEY)
        db.ref('transactions').on('value', (s) => {
            let tbody = document.getElementById('historyTableBody'); tbody.innerHTML = ''; let totalRev = 0;
            if(s.exists()) {
                let trans = s.val(); let keys = Object.keys(trans).reverse();
                keys.forEach(id => {
                    let t = trans[id]; totalRev += (t.amount || 0);
                    let time = new Date(t.time).toLocaleString('vi-VN');
                    
                    // Xử lý màu Key (nếu là Admin tạo sẽ có màu riêng)
                    let keyColor = t.color ? t.color : '#00ff88'; 
                    let keyDisp = t.key_granted ? `<span style="color:${keyColor}; font-weight:bold; font-family:monospace; background:#222; padding:3px 8px; border-radius:4px; border: 1px solid ${keyColor};">${t.key_granted}</span>` : 'N/A';
                    
                    let linkDisp = t.download_link ? `<a href="${t.download_link}" target="_blank" style="color:#1e90ff;">Tải ngay</a>` : 'N/A';
                    let userDisp = t.user === 'ADMIN_VIP_SPAWN' ? `<strong style="color:#f1c40f;"><i class="fas fa-crown"></i> ADMIN TẠO</strong>` : `<strong style="color:#00b8ff;">${t.user}</strong>`;
                    
                    tbody.innerHTML += `<tr><td style="font-size:12px; color:#aaa;">${time}</td><td>${userDisp}</td><td>${t.detail}</td><td>${keyDisp}</td><td>${linkDisp}</td></tr>`;
                });
            } else { tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Chưa có giao dịch nào</td></tr>`; }
            document.getElementById('statRevenue').innerText = formatMoney(totalRev);
        });

        // 5. NGƯỜI DÙNG & TRÌNH SỬA CODE
        db.ref('users').on('value', (s) => {
            let tbody = document.getElementById('userTableBody'); tbody.innerHTML = ''; let uCount = 0;
            if(s.exists()) {
                let users = s.val();
                for(let id in users) {
                    let u = users[id]; uCount++;
                    let status = u.banned ? '<span style="color:#ff4757; font-weight:bold;"><i class="fas fa-lock"></i> KHÓA</span>' : '<span style="color:#00ff88;">Hoạt động</span>';
                    tbody.innerHTML += `<tr><td><strong style="color:#00b8ff;">${id}</strong></td><td style="font-weight:bold; font-family:monospace;">${formatMoney(u.balance || 0)}</td><td>${status}</td><td><button class="action-btn money" onclick="openMoneyModal('${id}', ${u.balance || 0})"><i class="fas fa-coins"></i></button><button class="action-btn ban" onclick="openBanModal('${id}', ${u.banned || false}, '${u.banReason || ''}')"><i class="fas fa-gavel"></i></button></td></tr>`;
                }
            } else { tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">Chưa có dữ liệu</td></tr>`; }
            document.getElementById('statUsers').innerText = uCount;
        });
        function openMoneyModal(id, bal) { document.getElementById('uId').value = id; document.getElementById('uNewBalance').value = bal; document.getElementById('moneyModal').style.display = 'flex'; }
        function saveUserBalance() { db.ref('users/' + document.getElementById('uId').value + '/balance').set(Number(document.getElementById('uNewBalance').value)).then(() => { showAdminToast("Cập nhật số dư!"); closeModal('moneyModal'); }); }
        function openBanModal(id, isBan, reason) { document.getElementById('banUid').value = id; document.getElementById('banReason').value = isBan ? reason : ""; document.getElementById('btnUnbanBtn').style.display = isBan ? 'block' : 'none'; document.getElementById('banModal').style.display = 'flex'; }
        function executeBan() { db.ref('users/' + document.getElementById('banUid').value).update({ banned: true, banReason: document.getElementById('banReason').value }).then(() => { showAdminToast("Đã khóa!", true); closeModal('banModal'); }); }
        function unbanUser() { db.ref('users/' + document.getElementById('banUid').value).update({ banned: false, banReason: null }).then(() => { showAdminToast("Đã mở khóa!"); closeModal('banModal'); }); }

        // Code Editor
        function loadRawCode() { db.ref('raw_code/' + document.getElementById('pageSelect').value).once('value', snap => { document.getElementById('rawCodeArea').value = snap.val() || ""; }); }
        function saveRawCode() { if(confirm("CẢNH BÁO TỐI CAO: Mã này sẽ ghi đè lên giao diện!")) db.ref('raw_code/' + document.getElementById('pageSelect').value).set(document.getElementById('rawCodeArea').value).then(() => alert("Cập nhật mã nguồn thành công!")); }
        setTimeout(loadRawCode, 1000);
    </script>
</body>
</html>
